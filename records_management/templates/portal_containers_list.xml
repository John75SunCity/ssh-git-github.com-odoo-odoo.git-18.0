<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Container List View for Portal Users - Enhanced with Grok UI/UX -->
    <template id="portal_my_containers" name="My Containers">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">My Containers</t>
            </t>

            <div class="container mt-4 o_portal_inventory">
                <!-- Permission Indicator -->
                <t t-call="records_management.permission_card_header">
                    <t t-set="perm_key" t-value="'containers'"/>
                </t>
                
                <!-- Page Header with Actions (Grok Pattern) -->
                <div class="page-header d-flex justify-content-between align-items-center">
                    <h1>
                        <i class="fa fa-box"></i> My <t t-esc="field_labels.get('name', 'Container')"/>s
                        <span class="badge bg-primary ms-2" t-esc="container_count"/>
                        <t t-call="records_management.permission_indicator">
                            <t t-set="perm_key" t-value="'containers'"/>
                        </t>
                    </h1>
                    <div class="actions">
                        <!-- Camera Scan button for quick container lookup -->
                        <button type="button" 
                                class="btn btn-outline-info"
                                data-action="portal-camera-scan"
                                data-scan-type="container"
                                title="Scan container barcode with camera">
                            <i class="fa fa-barcode"></i> Scan Barcode
                        </button>
                        <!-- Add Container button -->
                        <t t-if="permissions.get('containers', {}).get('can_create')">
                            <a href="/my/inventory/containers/create" class="btn btn-success">
                                <i class="fa fa-plus-circle"></i> Add Container
                            </a>
                        </t>
                        <!-- View All Files button -->
                        <a href="/my/inventory/files" class="btn btn-outline-primary">
                            <i class="fa fa-folder"></i> View All Files
                        </a>
                        <!-- Export Dropdown -->
                        <div class="dropdown d-inline-block">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="exportContainersDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fa fa-download"></i> Export
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="exportContainersDropdown">
                                <li><a class="dropdown-item" href="#" onclick="exportContainers('xlsx')"><i class="fa fa-file-excel-o text-success"></i> Excel (.xlsx)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportContainers('csv')"><i class="fa fa-file-text-o text-primary"></i> CSV</a></li>
                                <li><hr class="dropdown-divider"/></li>
                                <li><a class="dropdown-item" href="/my/import/template/containers"><i class="fa fa-download text-info"></i> Download Import Template</a></li>
                            </ul>
                        </div>
                        <!-- Import Button -->
                        <button class="btn btn-outline-success" type="button" data-bs-toggle="modal" data-bs-target="#importContainersModal">
                            <i class="fa fa-upload"></i> Import
                        </button>
                    </div>
                </div>
                
                <!-- Import Containers Modal -->
                <div class="modal fade" id="importContainersModal" tabindex="-1" aria-labelledby="importContainersModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="importContainersModalLabel"><i class="fa fa-upload"></i> Import Containers</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form action="/my/import/containers" method="POST" enctype="multipart/form-data">
                                <div class="modal-body">
                                    <p class="text-muted">Upload a CSV or Excel file to bulk import containers.</p>
                                    <div class="mb-3">
                                        <label for="importContainerFile" class="form-label">Select File</label>
                                        <input type="file" class="form-control" id="importContainerFile" name="file" accept=".csv,.xlsx" required="required"/>
                                    </div>
                                    <div class="alert alert-info">
                                        <strong>Required columns:</strong> Container Number<br/>
                                        <strong>Optional columns:</strong> Description, Department, Retention Policy, Destruction Due Date<br/>
                                        <a href="/my/import/template/containers">Download the import template</a> to see the required format.
                                    </div>
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary"><i class="fa fa-upload"></i> Import</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Filter Tabs (State-based) -->
                <ul class="nav nav-tabs mb-3" id="containerStateTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a t-att-class="'nav-link' + (' active' if not state_filter or state_filter == 'all' else '')" 
                           href="/my/containers?state_filter=all">
                            <i class="fa fa-list"></i> All
                            <span class="badge bg-secondary ms-1" t-esc="counts.get('all', 0)"/>
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a t-att-class="'nav-link' + (' active' if state_filter == 'in' else '')"
                           href="/my/containers?state_filter=in">
                            <i class="fa fa-warehouse text-success"></i> In Storage
                            <span class="badge bg-success ms-1" t-esc="counts.get('in', 0)"/>
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a t-att-class="'nav-link' + (' active' if state_filter == 'out' else '')"
                           href="/my/containers?state_filter=out">
                            <i class="fa fa-truck text-warning"></i> Out (With You)
                            <span class="badge bg-warning text-dark ms-1" t-esc="counts.get('out', 0)"/>
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a t-att-class="'nav-link' + (' active' if state_filter == 'pending' else '')"
                           href="/my/containers?state_filter=pending">
                            <i class="fa fa-clock text-info"></i> Pending (Ready for Storage)
                            <span class="badge bg-info ms-1" t-esc="counts.get('pending', 0)"/>
                        </a>
                    </li>
                </ul>
                
                <!-- Context-Aware Action Banner -->
                <t t-if="state_filter == 'out' and counts.get('out', 0) > 0">
                    <div class="alert alert-warning d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fa fa-info-circle"></i>
                            <strong>These containers are currently with you.</strong> 
                            Select items to return to warehouse storage.
                        </div>
                        <button class="btn btn-success btn-sm" onclick="ContainerBulkActions.selectAllAndReturn()">
                            <i class="fa fa-check-double"></i> Select All &amp; Return to Warehouse
                        </button>
                    </div>
                </t>
                <t t-if="state_filter == 'pending' and counts.get('pending', 0) > 0">
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fa fa-info-circle"></i>
                            <strong>These containers are ready for initial storage.</strong>
                            Select items to send to our warehouse for secure storage.
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="ContainerBulkActions.selectAllAndSendToStorage()">
                            <i class="fa fa-check-double"></i> Select All &amp; Send to Storage
                        </button>
                    </div>
                </t>

                <!-- Filter Bar (Grok Enhanced) -->
                <div class="filter-bar">
                    <form method="get">
                        <input type="hidden" name="state_filter" t-att-value="state_filter or 'all'"/>
                        <div class="row">
                            <!-- Search Input -->
                            <div class="col-md-3 mb-2">
                                <input type="text"
                                       name="search"
                                       class="form-control search-input"
                                       placeholder="Search containers..."
                                       t-att-value="search or ''"/>
                            </div>

                            <!-- Status Filter -->
                            <div class="col-md-3 mb-2">
                                <select name="filterby" class="form-select" onchange="this.form.submit()">
                                    <option value="all">All Status</option>
                                    <t t-foreach="(searchbar_filters or {}).items()" t-as="filter_item">
                                        <t t-set="filter_key" t-value="filter_item[0]"/>
                                        <t t-set="filter_data" t-value="filter_item[1]"/>
                                        <option t-att-value="filter_key"
                                                t-att-selected="'selected' if filterby == filter_key else None">
                                            <t t-esc="filter_data.get('label', filter_key)"/>
                                        </option>
                                    </t>
                                </select>
                            </div>

                            <!-- Date Range -->
                            <div class="col-md-2 mb-2">
                                <input type="date" name="date_from" class="form-control" placeholder="Date From"/>
                            </div>
                            <div class="col-md-2 mb-2">
                                <input type="date" name="date_to" class="form-control" placeholder="Date To"/>
                            </div>

                            <div class="col-md-2 mb-2">
                                <button type="submit" class="btn btn-purple w-100">
                                    <i class="fa fa-filter"></i> Filter
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Container Table (Responsive) -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="containersTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAll" class="form-check-input"/>
                                </th>
                                <th><t t-esc="field_labels.get('name', 'Container Number')"/></th>
                                <th>Status</th>
                                <th>Location</th>
                                <th><t t-esc="field_labels.get('department_id', 'Department')"/></th>
                                <th>Date Stored</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-if="containers">
                                <t t-foreach="containers" t-as="container">
                                    <tr>
                                        <td>
                                            <input type="checkbox" 
                                                   class="form-check-input container-checkbox" 
                                                   t-att-value="container.id"
                                                   t-att-data-name="container.name"
                                                   t-att-data-barcode="container.barcode"/>
                                        </td>
                                        <td>
                                            <strong t-esc="container.name"/>
                                            <br/>
                                            <small class="text-muted" t-if="container.barcode">
                                                <i class="fa fa-barcode"></i> <t t-esc="container.barcode"/>
                                            </small>
                                        </td>
                                        <td>
                                            <span t-att-class="'badge bg-' + ('success' if container.state == 'in' else 'warning' if container.state == 'pending' else 'info' if container.state == 'out' else 'secondary' if container.state == 'perm_out' else 'danger')">
                                                <t t-esc="container.state_display or 'Pending'"/>
                                            </span>
                                        </td>
                                        <td t-esc="container.location_id.name if container.location_id else 'Not Set'"/>
                                        <td t-esc="container.department_id.name if container.department_id else '-'"/>
                                        <td t-esc="container.create_date"/>
                                        <td>
                                            <a t-attf-href="/my/inventory/container/{{container.id}}" 
                                               class="btn btn-sm btn-info">
                                                <i class="fa fa-eye"></i> View
                                            </a>
                                        </td>
                                    </tr>
                                </t>
                            </t>
                            <t t-else="">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="fa fa-inbox fa-3x mb-3"></i>
                                        <p>No containers found</p>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <t t-if="pager">
                    <t t-call="portal.pager"/>
                </t>
                
                <!-- Bulk Action Toolbar (hidden by default, appears when items selected) -->
                <!-- Mobile-responsive: uses max-width on larger screens, full-width on mobile -->
                <div id="container_bulk_action_toolbar" class="alert alert-info" style="display:none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1050; box-shadow: 0 -4px 12px rgba(0,0,0,0.15); border-radius: 8px 8px 0 0; margin: 0; padding: 12px;">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
                        <div class="text-center text-md-start mb-2 mb-md-0">
                            <strong><i class="fa fa-box"></i> <span id="container_selection_count">0</span> container(s) selected</strong>
                        </div>
                        <div class="d-flex flex-wrap justify-content-center gap-1" role="group" id="bulk_action_buttons">
                            <!-- Dynamic buttons based on state filter -->
                        </div>
                    </div>
                </div>
                
                <!-- Bulk Actions and Export Script -->
                <script type="text/javascript">
                    var ContainerBulkActions = {
                        selectedContainers: new Set(),
                        stateFilter: '<t t-esc="state_filter or 'all'"/>',
                        
                        init: function() {
                            var self = this;
                            var selectAllCheckbox = document.getElementById('selectAll');
                            var containerCheckboxes = document.querySelectorAll('.container-checkbox');
                            
                            if (selectAllCheckbox) {
                                selectAllCheckbox.addEventListener('change', function() {
                                    var isChecked = this.checked;
                                    containerCheckboxes.forEach(function(checkbox) {
                                        checkbox.checked = isChecked;
                                    });
                                    self.updateSelection();
                                });
                            }
                            
                            containerCheckboxes.forEach(function(checkbox) {
                                checkbox.addEventListener('change', function() {
                                    self.updateSelection();
                                });
                            });
                            
                            // Export button
                            var exportBtn = document.querySelector('.btn-export');
                            if (exportBtn) {
                                exportBtn.addEventListener('click', function() {
                                    self.exportSelected();
                                });
                            }
                            
                            // Build dynamic action buttons based on state filter
                            this.buildActionButtons();
                        },
                        
                        buildActionButtons: function() {
                            var buttonsContainer = document.getElementById('bulk_action_buttons');
                            if (!buttonsContainer) return;
                            
                            var buttons = '';
                            
                            if (this.stateFilter === 'out') {
                                // Items currently with customer - show Return to Warehouse
                                buttons = `
                                    &lt;button type="button" class="btn btn-sm btn-success" onclick="ContainerBulkActions.requestReturnToWarehouse()"&gt;
                                        &lt;i class="fa fa-warehouse"&gt;&lt;/i&gt; Return to Warehouse
                                    &lt;/button&gt;
                                `;
                            } else if (this.stateFilter === 'pending') {
                                // Pending items - show Send to Storage
                                buttons = `
                                    &lt;button type="button" class="btn btn-sm btn-primary" onclick="ContainerBulkActions.sendToStorage()"&gt;
                                        &lt;i class="fa fa-warehouse"&gt;&lt;/i&gt; Send to Storage
                                    &lt;/button&gt;
                                `;
                            } else if (this.stateFilter === 'in') {
                                // In storage - show Request Retrieval
                                buttons = `
                                    &lt;button type="button" class="btn btn-sm btn-primary" onclick="ContainerBulkActions.requestRetrieval()"&gt;
                                        &lt;i class="fa fa-truck"&gt;&lt;/i&gt; Request Retrieval
                                    &lt;/button&gt;
                                    &lt;button type="button" class="btn btn-sm btn-danger" onclick="ContainerBulkActions.requestDestruction()"&gt;
                                        &lt;i class="fa fa-fire"&gt;&lt;/i&gt; Request Destruction
                                    &lt;/button&gt;
                                `;
                            } else {
                                // All - show all options
                                buttons = `
                                    &lt;button type="button" class="btn btn-sm btn-primary" onclick="ContainerBulkActions.requestRetrieval()"&gt;
                                        &lt;i class="fa fa-truck"&gt;&lt;/i&gt; Retrieval
                                    &lt;/button&gt;
                                    &lt;button type="button" class="btn btn-sm btn-success" onclick="ContainerBulkActions.requestReturnToWarehouse()"&gt;
                                        &lt;i class="fa fa-warehouse"&gt;&lt;/i&gt; Return
                                    &lt;/button&gt;
                                    &lt;button type="button" class="btn btn-sm btn-info" onclick="ContainerBulkActions.sendToStorage()"&gt;
                                        &lt;i class="fa fa-archive"&gt;&lt;/i&gt; To Storage
                                    &lt;/button&gt;
                                    &lt;button type="button" class="btn btn-sm btn-danger" onclick="ContainerBulkActions.requestDestruction()"&gt;
                                        &lt;i class="fa fa-fire"&gt;&lt;/i&gt; Destroy
                                    &lt;/button&gt;
                                `;
                            }
                            
                            buttons += `
                                &lt;button type="button" class="btn btn-sm btn-secondary" onclick="ContainerBulkActions.clearSelection()"&gt;
                                    &lt;i class="fa fa-times"&gt;&lt;/i&gt; Clear
                                &lt;/button&gt;
                            `;
                            
                            buttonsContainer.innerHTML = buttons;
                        },
                        
                        updateSelection: function() {
                            this.selectedContainers.clear();
                            var self = this;
                            document.querySelectorAll('.container-checkbox:checked').forEach(function(cb) {
                                self.selectedContainers.add(parseInt(cb.value));
                            });
                            
                            var count = this.selectedContainers.size;
                            var toolbar = document.getElementById('container_bulk_action_toolbar');
                            var countSpan = document.getElementById('container_selection_count');
                            
                            if (count > 0) {
                                toolbar.style.display = 'block';
                                countSpan.textContent = count;
                            } else {
                                toolbar.style.display = 'none';
                            }
                        },
                        
                        clearSelection: function() {
                            document.querySelectorAll('.container-checkbox, #selectAll').forEach(function(cb) {
                                cb.checked = false;
                            });
                            this.updateSelection();
                        },
                        
                        submitRequest: function(requestType, confirmMessage) {
                            if (this.selectedContainers.size === 0) {
                                alert('Please select at least one container.');
                                return;
                            }
                            
                            if (!confirm(confirmMessage)) {
                                return;
                            }
                            
                            var containerIds = Array.from(this.selectedContainers);
                            
                            fetch('/my/containers/bulk_request', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'call',
                                    params: {
                                        request_type: requestType,
                                        container_ids: containerIds
                                    }
                                })
                            })
                            .then(function(response) { return response.json(); })
                            .then(function(data) {
                                if (data.result &amp;&amp; data.result.success) {
                                    alert(data.result.message);
                                    window.location.href = '/my/requests/' + data.result.request_id;
                                } else {
                                    alert('Error: ' + (data.result ? data.result.error : 'Unknown error'));
                                }
                            })
                            .catch(function(error) {
                                alert('Network error. Please try again.');
                                console.error('Error:', error);
                            });
                        },
                        
                        requestRetrieval: function() {
                            this.submitRequest(
                                'retrieval',
                                'Submit retrieval request for ' + this.selectedContainers.size + ' container(s)?\\n\\nThis will create a work order for our team to deliver these containers to you.'
                            );
                        },
                        
                        requestReturnToWarehouse: function() {
                            this.submitRequest(
                                'return_to_warehouse',
                                'Submit return to warehouse request for ' + this.selectedContainers.size + ' container(s)?\\n\\nOur team will pick up the containers from your location and return them to secure storage.'
                            );
                        },
                        
                        requestDestruction: function() {
                            this.submitRequest(
                                'destruction',
                                'Submit destruction request for ' + this.selectedContainers.size + ' container(s)?\\n\\n⚠️ WARNING: This will permanently destroy the selected containers and their contents.\\n\\nCharges will apply:\\n• Removal fee: $15/container\\n• Shredding fee: $25/container'
                            );
                        },
                        
                        sendToStorage: function() {
                            this.submitRequest(
                                'send_to_storage',
                                'Send ' + this.selectedContainers.size + ' container(s) to storage?\\n\\nOur team will pick up these pending containers from your location and place them in secure warehouse storage.\\n\\nThis initiates your storage service for these items.'
                            );
                        },
                        
                        selectAllAndReturn: function() {
                            // Select all checkboxes
                            document.querySelectorAll('.container-checkbox').forEach(function(cb) {
                                cb.checked = true;
                            });
                            document.getElementById('selectAll').checked = true;
                            this.updateSelection();
                            // Trigger the return action
                            this.requestReturnToWarehouse();
                        },
                        
                        selectAllAndSendToStorage: function() {
                            // Select all checkboxes
                            document.querySelectorAll('.container-checkbox').forEach(function(cb) {
                                cb.checked = true;
                            });
                            document.getElementById('selectAll').checked = true;
                            this.updateSelection();
                            // Trigger the send to storage action
                            this.sendToStorage();
                        },
                        
                        exportSelected: function() {
                            // Get selected container IDs
                            var selectedIds = Array.from(this.selectedContainers);
                            
                            if (selectedIds.length === 0) {
                                // If no selection, export all visible containers
                                // Redirect to server-side export with current filters
                                window.location.href = '/my/containers/export?format=xlsx';
                                return;
                            }
                            
                            // Export selected containers via server-side handler
                            window.location.href = '/my/containers/export?format=xlsx&amp;container_ids=' + selectedIds.join(',');
                        },
                        
                        exportAllAsCsv: function() {
                            window.location.href = '/my/containers/export?format=csv';
                        }
                    };
                    
                    // Global export function for dropdown
                    function exportContainers(format) {
                        var selectedIds = Array.from(ContainerBulkActions.selectedContainers);
                        var url = '/my/containers/export?format=' + format;
                        if (selectedIds.length > 0) {
                            url += '&amp;container_ids=' + selectedIds.join(',');
                        }
                        window.location.href = url;
                    }
                    
                    document.addEventListener('DOMContentLoaded', function() {
                        ContainerBulkActions.init();
                    });
                </script>

                <!-- Loading Overlay (for AJAX operations) -->
                <div class="loading-overlay d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>
