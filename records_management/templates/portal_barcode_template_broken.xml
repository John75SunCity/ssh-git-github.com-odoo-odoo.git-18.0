<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="portal_barcode_template" name="Portal Barcode Template">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-set="pageName" t-value="'barcode'"/>
            <t t-set="title">Barcode Management</t>

            <div class="container-fluid rm-portal-barcode">
                <!-- Barcode Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h4 class="mb-0">
                                            <i class="fa fa-barcode me-2"></i>
                                            Barcode Management
                                        </h4>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateBarcodeModal">
                                            <i class="fa fa-plus me-1"></i>
                                            Generate Barcode
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Barcode Content -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <p class="text-muted">Barcode management functionality will be implemented here.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generate Barcode Modal -->
            <div class="modal fade" id="generateBarcodeModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Generate Barcode</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>Barcode generation form will be here.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>
                <!-- Barcode Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h4 class="mb-0">
                                            <i class="fa fa-barcode me-2"></i>
                                            Barcode Management
                                        </h4>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <button class="btn btn-primary" data-action="generate-barcode">
                                            <i class="fa fa-plus me-2"></i>Generate Barcode
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Barcode Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <div class="h1 text-primary mb-2" t-esc="barcode_stats.total or 0"/>
                                <h5 class="card-title">Total Barcodes</h5>
                                <p class="card-text text-muted">Active barcodes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <div class="h1 text-success mb-2" t-esc="barcode_stats.generated_today or 0"/>
                                <h5 class="card-title">Generated Today</h5>
                                <p class="card-text text-muted">New barcodes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <div class="h1 text-info mb-2" t-esc="barcode_stats.scanned_today or 0"/>
                                <h5 class="card-title">Scanned Today</h5>
                                <p class="card-text text-muted">Usage count</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <div class="h1 text-warning mb-2" t-esc="barcode_stats.expired or 0"/>
                                <h5 class="card-title">Expired</h5>
                                <p class="card-text text-muted">Need renewal</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Barcode Search and Filter -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="barcodeSearch" placeholder="Search by barcode, container, or location..."/>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="barcodeTypeFilter">
                                            <option value="">All Types</option>
                                            <option value="container">Container</option>
                                            <option value="location">Location</option>
                                            <option value="document">Document</option>
                                            <option value="box">Storage Box</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="barcodeStatusFilter">
                                            <option value="">All Status</option>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                            <option value="expired">Expired</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary w-100" data-action="clear-filters">
                                            <i class="fa fa-times me-1"></i>Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Barcode List -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fa fa-list me-2"></i>
                                    Barcode Inventory
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="barcodeTable">
                                        <thead>
                                            <tr>
                                                <th>Barcode</th>
                                                <th>Type</th>
                                                <th>Associated Item</th>
                                                <th>Location</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Last Scanned</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="barcodes" t-as="barcode">
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="barcode-display me-3">
                                                                <img t-attf-src="data:image/png;base64,{{ barcode.barcode_image }}" alt="Barcode" class="img-fluid" style="max-height: 40px;"/>
                                                            </div>
                                                            <div>
                                                                <code t-esc="barcode.name"/>
                                                                <br/>
                                                                <small class="text-muted">Format: <t t-esc="barcode.barcode_format"/></small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span t-attf-class="badge {{ barcode.type_badge_class }}">
                                                            <t t-esc="barcode.barcode_type"/>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <t t-if="barcode.container_id">
                                                            <strong>Container:</strong> <t t-esc="barcode.container_id.name"/>
                                                        </t>
                                                        <t t-foreach="generation_history" t-as="history">
                                                            <tr>
                                                                <td>
                                                                    <t t-esc="history.date.strftime('%m/%d/%Y')"/>
                                                                    <br/>
                                                                    <small class="text-muted"><t t-esc="history.date.strftime('%H:%M')"/></small>
                                                                </td>
                                                                <td><t t-esc="history.generated_by"/></td>
                                                                <td>
                                                                    <span t-attf-class="badge {{ history.type_badge_class }}">
                                                                        <t t-esc="history.barcode_type"/>
                                                                    </span>
                                                                </td>
                                                                <td><t t-esc="history.count"/></td>
                                                                <td><t t-esc="history.purpose or '-'"/></td>
                                                                <td>
                                                                    <t t-if="history.status == 'success'">
                                                                        <span class="badge badge-success">Success</span>
                                                                    </t>
                                                                    <t t-elif="history.status == 'partial'">
                                                                        <span class="badge badge-warning">Partial</span>
                                                                    </t>
                                                                    <t t-else="">
                                                                        <span class="badge badge-secondary" t-esc="history.status"/>
                                                                    </t>
                                                                </td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Barcode Details Modal -->
                            <div class="modal fade" id="barcodeDetailsModal" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-lg modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Barcode Details</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col-md-6 text-center">
                                                    <img id="modalBarcodeImage" src="/web/image/res.company/1/logo" alt="Barcode Image" class="img-fluid mb-3" style="max-height:160px;"/>
                                                    <div class="btn-group mb-3" role="group">
                                                        <button class="btn btn-outline-primary" data-action="print-barcode-image">
                                                            <i class="fa fa-print me-1"></i>Print
                                                        </button>
                                                        <button class="btn btn-outline-secondary" data-action="download-barcode-image">
                                                            <i class="fa fa-download me-1"></i>Download
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6>Barcode Information</h6>
                                                    <dl class="row mb-0">
                                                        <dt class="col-sm-4">Barcode</dt>
                                                        <dd class="col-sm-8"><code id="detailBarcodeValue">N/A</code></dd>
                                                        <dt class="col-sm-4">Type</dt>
                                                        <dd class="col-sm-8" id="detailBarcodeType">N/A</dd>
                                                        <dt class="col-sm-4">Status</dt>
                                                        <dd class="col-sm-8" id="detailBarcodeStatus">N/A</dd>
                                                        <dt class="col-sm-4">Created</dt>
                                                        <dd class="col-sm-8" id="detailBarcodeCreated">N/A</dd>
                                                        <dt class="col-sm-4">Last Scan</dt>
                                                        <dd class="col-sm-8" id="detailBarcodeLastScan">Never</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                            <hr/>
                                            <h6 class="mt-3">Associated Records</h6>
                                            <div class="table-responsive mb-3">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Type</th>
                                                            <th>Name / Reference</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="barcodeAssociatedRecords">
                                                        <tr>
                                                            <td colspan="4" class="text-center text-muted">No associated records</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Inline logic removed; handled by records_management.portal_barcode_management JS module -->
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Generated By</th>
                                                <th>Type</th>
                                                <th>Count</th>
                                                <th>Purpose</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="generation_history" t-as="history">
                                                <tr>
                                                    <td>
                                                        <t t-esc="history.date.strftime('%m/%d/%Y')"/>
                                                        <br/>
                                                        <small class="text-muted"><t t-esc="history.date.strftime('%H:%M')"/></small>
                                                    </td>
                                                    <td><t t-esc="history.generated_by"/></td>
                                                    <td>
                                                        <span t-attf-class="badge {{ history.type_badge_class }}">
                                                            <!-- Inline script removed: functionality moved to portal_barcode_management.js -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                function generateNewBarcode() {
                    // Implementation for generating new barcode
                    console.log('Generating new barcode...');
                }

                function printBarcode(barcodeId) {
                    // Implementation for printing barcode
                    console.log('Printing barcode:', barcodeId);
                }

                function viewBarcodeDetails(barcodeId) {
                    // Implementation for viewing barcode details
                    console.log('Viewing barcode details:', barcodeId);
                    // Show modal with barcode details
                    $('#barcodeDetailsModal').modal('show');
                }

                function editBarcode(barcodeId) {
                    // Implementation for editing barcode
                    console.log('Editing barcode:', barcodeId);
                }

                function duplicateBarcode(barcodeId) {
                    // Implementation for duplicating barcode
                    console.log('Duplicating barcode:', barcodeId);
                }

                function deactivateBarcode(barcodeId) {
                    // Implementation for deactivating barcode
                    console.log('Deactivating barcode:', barcodeId);
                }

                function filterBarcodes() {
                    // Implementation for filtering barcodes
                    const searchTerm = $('#barcodeSearch').val().toLowerCase();
                    const typeFilter = $('#barcodeTypeFilter').val();
                    const statusFilter = $('#barcodeStatusFilter').val();

                    $('#barcodeTable tbody tr').each(function() {
                        const row = $(this);
                        const barcodeText = row.find('code').text().toLowerCase();
                        const typeText = row.find('td:nth-child(2)').text().toLowerCase();
                        const statusText = row.find('td:nth-child(5)').text().toLowerCase();

                        const matchesSearch = !searchTerm || barcodeText.includes(searchTerm);
                        const matchesType = !typeFilter || typeText.includes(typeFilter.toLowerCase());
                        const matchesStatus = !statusFilter || statusText.includes(statusFilter.toLowerCase());

                        if (matchesSearch &amp;&amp; matchesType &amp;&amp; matchesStatus) {
                            row.show();
                        } else {
                            row.hide();
                        }
                    });
                }

                function clearFilters() {
                    $('#barcodeSearch').val('');
                    $('#barcodeTypeFilter').val('');
                    $('#barcodeStatusFilter').val('');
                    filterBarcodes();
                }

                function printBarcodeImage() {
                    // Implementation for printing barcode image
                    const printWindow = window.open('', '_blank');
                    const barcodeImage = $('#modalBarcodeImage').attr('src');
                    printWindow.document.write('<img src="' + barcodeImage + '" style="max-width: 100%;"/>');
                    printWindow.document.close();
                    printWindow.print();
                }

                function downloadBarcodeImage() {
                    // Implementation for downloading barcode image
                    const link = document.createElement('a');
                    link.href = $('#modalBarcodeImage').attr('src');
                    link.download = 'barcode.png';
                    link.click();
                }
            </script>
        </t>
    </template>
</odoo>
