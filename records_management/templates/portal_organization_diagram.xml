<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Portal Organization Diagram Template -->
    <template id="portal_organization_diagram" name="Organization Diagram">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <div class="container-fluid o_portal_organization_diagram">
                <!-- Header Section -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex align-items-center justify-content-between flex-wrap">
                            <h1 class="h3 mb-0">
                                <i class="fa fa-sitemap text-primary mr-2"/>
                                Organization Diagram
                            </h1>
                            <div class="btn-toolbar">
                                <div class="btn-group mr-2">
                                    <button class="btn btn-outline-primary" id="refresh-diagram">
                                        <i class="fa fa-refresh"/> Refresh
                                    </button>
                                    <button class="btn btn-outline-secondary" id="export-diagram">
                                        <i class="fa fa-download"/> Export
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-outline-info" data-toggle="modal" data-target="#diagram-help-modal">
                                        <i class="fa fa-question-circle"/> Help
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="search-query">Search People &amp; Departments</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="search-query" 
                                                       placeholder="Search by name, department, or role..."
                                                       t-att-value="diagram.search_query or ''"/>
                                                <div class="input-group-append">
                                                    <button class="btn btn-primary" type="button" id="search-button">
                                                        <i class="fa fa-search"/>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="layout-select">Layout Style</label>
                                            <select class="form-control" id="layout-select">
                                                <option value="hierarchical" t-att-selected="diagram.layout_type == 'hierarchical' and 'selected' or None">
                                                    Hierarchical
                                                </option>
                                                <option value="network" t-att-selected="diagram.layout_type == 'network' and 'selected' or None">
                                                    Network
                                                </option>
                                                <option value="circular" t-att-selected="diagram.layout_type == 'circular' and 'selected' or None">
                                                    Circular
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>Options</label><br/>
                                            <div class="form-check form-check-inline" t-if="diagram.show_messaging">
                                                <input class="form-check-input" type="checkbox" id="enable-messaging" checked="checked"/>
                                                <label class="form-check-label" for="enable-messaging">
                                                    Enable Messaging
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4" id="diagram-stats">
                    <div class="col-md-3">
                        <div class="card text-center border-primary">
                            <div class="card-body">
                                <h5 class="card-title text-primary">
                                    <i class="fa fa-building"/>
                                </h5>
                                <h4 class="mb-0" id="companies-count">-</h4>
                                <small class="text-muted">Companies</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <h5 class="card-title text-success">
                                    <i class="fa fa-sitemap"/>
                                </h5>
                                <h4 class="mb-0" id="departments-count">-</h4>
                                <small class="text-muted">Departments</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-info">
                            <div class="card-body">
                                <h5 class="card-title text-info">
                                    <i class="fa fa-users"/>
                                </h5>
                                <h4 class="mb-0" id="users-count">-</h4>
                                <small class="text-muted">People</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <h5 class="card-title text-warning">
                                    <i class="fa fa-link"/>
                                </h5>
                                <h4 class="mb-0" id="connections-count">-</h4>
                                <small class="text-muted">Connections</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Diagram Container -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Interactive Organization Map</h5>
                                <div class="diagram-legend">
                                    <small class="text-muted">
                                        <span class="badge badge-warning">Companies</span>
                                        <span class="badge badge-success">Departments</span>
                                        <span class="badge badge-info">Internal Users</span>
                                        <span class="badge badge-pink">Portal Users</span>
                                        <span class="badge badge-danger">You</span>
                                    </small>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <!-- Diagram will be rendered here -->
                                <div id="organization-diagram-container" style="height: 600px; background: #f8f9fa; position: relative;">
                                    <div class="loading-overlay text-center" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                        <p class="mt-3 text-muted">Loading organization diagram...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Node Details Modal -->
                <div class="modal fade" id="node-details-modal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="node-modal-title">Node Details</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body" id="node-modal-body">
                                <!-- Node details will be populated here -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary d-none" id="message-user-btn">
                                    <i class="fa fa-envelope"/> Send Message
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Help Modal -->
                <div class="modal fade" id="diagram-help-modal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Organization Diagram Help</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <h6>Navigation</h6>
                                <ul>
                                    <li><strong>Pan:</strong> Click and drag to move around the diagram</li>
                                    <li><strong>Zoom:</strong> Use mouse wheel to zoom in and out</li>
                                    <li><strong>Select:</strong> Click on nodes to see details</li>
                                    <li><strong>Message:</strong> Click on person nodes to send direct messages</li>
                                </ul>

                                <h6>Node Types</h6>
                                <ul>
                                    <li><strong>Companies:</strong> Golden boxes representing company entities</li>
                                    <li><strong>Departments:</strong> Green ellipses showing organizational departments</li>
                                    <li><strong>People:</strong> Colored circles representing users in the organization</li>
                                </ul>

                                <h6>Colors &amp; Meaning</h6>
                                <ul>
                                    <li><strong>Red Node:</strong> That's you! Your position in the organization</li>
                                    <li><strong>Blue Nodes:</strong> Internal employees and managers</li>
                                    <li><strong>Pink Nodes:</strong> External portal users and customers</li>
                                    <li><strong>Green Lines:</strong> Positive access rights or permissions</li>
                                    <li><strong>Red Lines:</strong> Restricted access or denied permissions</li>
                                </ul>

                                <h6>Interactive Features</h6>
                                <ul>
                                    <li><strong>Search:</strong> Use the search box to find specific people or departments</li>
                                    <li><strong>Layout Options:</strong> Switch between hierarchical, network, and circular views</li>
                                    <li><strong>Messaging:</strong> Click on colleagues to open the message composer</li>
                                    <li><strong>Export:</strong> Download the diagram data for external use</li>
                                </ul>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-dismiss="modal">Got it!</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Pass diagram data to JavaScript -->
            <script type="application/json" id="diagram-data">
                {
                    "nodes": <t t-out="diagram.node_data or '[]'"/>,
                    "edges": <t t-out="diagram.edge_data or '[]'"/>,
                    "stats": <t t-out="diagram.diagram_stats or '{}'"/>,
                    "config": {
                        "show_messaging": <t t-out="diagram.show_messaging and 'true' or 'false'"/>,
                        "show_access_rights": <t t-out="diagram.show_access_rights and 'true' or 'false'"/>,
                        "layout_type": "<t t-out="diagram.layout_type"/>",
                        "diagram_id": <t t-out="diagram.id"/>,
                        "user_id": <t t-out="user.id"/>,
                        "partner_id": <t t-out="partner.id"/>
                    }
                }
            </script>

        </t>
    </template>

    <!-- Extend Portal Sidebar Menu -->
    <template id="portal_organization_menu" inherit_id="portal.portal_sidebar" customize_show="True" name="Organization Menu">
        <xpath expr="//ul[@class='list-group']" position="inside">
            <li class="list-group-item">
                <a href="/my/organization" class="d-flex align-items-center">
                    <i class="fa fa-sitemap mr-2 text-primary"/>
                    <span>Organization</span>
                </a>
            </li>
        </xpath>
    </template>

    <!-- Add custom CSS -->
    <template id="portal_organization_diagram_assets" name="Organization Diagram Assets">
        <xpath expr="." position="inside">
            <style>
                .o_portal_organization_diagram {
                    min-height: 100vh;
                }
                
                .badge-pink {
                    background-color: #ff69b4;
                    color: white;
                }
                
                .loading-overlay {
                    z-index: 1000;
                }
                
                #organization-diagram-container {
                    border: 1px solid #dee2e6;
                    border-radius: 0 0 0.375rem 0.375rem;
                }
                
                .diagram-legend .badge {
                    margin-right: 0.5rem;
                }
                
                .card .card-body h4 {
                    font-weight: bold;
                }
                
                @media (max-width: 768px) {
                    #organization-diagram-container {
                        height: 400px !important;
                    }
                    
                    .btn-toolbar {
                        margin-top: 1rem;
                        width: 100%;
                        justify-content: center;
                    }
                }
            </style>
        </xpath>
    </template>

</odoo>
