<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Enhanced Portal Navigation with Feedback and Centralized Documents -->
        <template id="portal_my_home_inventory" name="Portal My Home : Inventory" inherit_id="portal.portal_my_home" priority="40">
            <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
                <t t-if="not (portal_dashboard_cards or [])" t-call="portal.portal_docs_entry">
                    <t t-set="title">My Inventory</t>
                    <t t-set="url" t-value="'/my/inventory'"/>
                    <t t-set="placeholder_count" t-value="'inventory_count'"/>
                </t>
                <t t-if="not (portal_dashboard_cards or [])" t-call="portal.portal_docs_entry">
                    <t t-set="title">Billing</t>
                    <t t-set="url" t-value="'/my/billing'"/>
                    <t t-set="placeholder_count" t-value="'billing_count'"/>
                </t>
                <t t-if="not (portal_dashboard_cards or [])" t-call="portal.portal_docs_entry">
                    <t t-set="title">Quotes</t>
                    <t t-set="url" t-value="'/my/quotes'"/>
                    <t t-set="placeholder_count" t-value="'quotes_count'"/>
                </t>
                <t t-if="not (portal_dashboard_cards or [])" t-call="portal.portal_docs_entry">
                    <t t-set="title">Requests</t>
                    <t t-set="url" t-value="'/my/requests'"/>
                    <t t-set="placeholder_count" t-value="'requests_count'"/>
                </t>
                <t t-if="not (portal_dashboard_cards or [])" t-call="portal.portal_docs_entry">
                    <t t-set="title">User Management</t>
                    <t t-set="url" t-value="'/my/users'"/>
                    <t t-set="placeholder_count" t-value="'users_count'"/>
                </t>
                <t t-if="not (portal_dashboard_cards or [])" t-call="portal.portal_docs_entry">
                    <t t-set="title">Portal Overview</t>
                    <t t-set="url" t-value="'/my/overview'"/>
                    <t t-set="placeholder_count" t-value="'overview_count'"/>
                </t>
                <t t-if="not (portal_dashboard_cards or [])" t-call="portal.portal_docs_entry">
                    <t t-set="title">Feedback &amp; Suggestions</t>
                    <t t-set="url" t-value="'/my/feedback'"/>
                    <t t-set="placeholder_count" t-value="'feedback_count'"/>
                </t>
                <t t-if="not (portal_dashboard_cards or [])" t-call="portal.portal_docs_entry">
                    <t t-set="title">Document Center</t>
                    <t t-set="url" t-value="'/my/docs'"/>
                    <t t-set="placeholder_count" t-value="'docs_count'"/>
                </t>
            </xpath>
        </template>

        <!-- Modern Tabbed Inventory Interface -->
        <template id="portal_my_inventory" name="My Inventory">
            <t t-call="portal.portal_layout">
                <t t-set="breadcrumbs_searchbar" t-value="True"/>
                <t t-set="title">My Inventory</t>

                <!-- Main Tabbed Inventory Interface -->
                <div class="container-fluid mt-4">
                    <!-- Navigation Tabs (Bootstrap 5 data-bs-* attributes) -->
                    <ul class="nav nav-tabs nav-justified mb-4" id="inventoryTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
                                <i class="fa fa-dashboard"></i> Overview
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="containers-tab" data-bs-toggle="tab" data-bs-target="#containers" type="button" role="tab" aria-controls="containers" aria-selected="false">
                                <i class="fa fa-archive"></i> Containers/Boxes
                                <span class="badge bg-primary ms-1" id="containers-badge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab" aria-controls="files" aria-selected="false">
                                <i class="fa fa-folder"></i> File Folders
                                <span class="badge bg-info ms-1" id="files-badge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab" aria-controls="documents" aria-selected="false">
                                <i class="fa fa-file-text"></i> Documents &amp; PDFs
                                <span class="badge bg-success ms-1" id="documents-badge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="temp-tab" data-bs-toggle="tab" data-bs-target="#temp" type="button" role="tab" aria-controls="temp" aria-selected="false">
                                <i class="fa fa-clock-o"></i> Temp Inventory
                                <span class="badge bg-warning ms-1" id="temp-badge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="locations-tab" data-bs-toggle="tab" data-bs-target="#locations" type="button" role="tab" aria-controls="locations" aria-selected="false">
                                <i class="fa fa-map-marker"></i> My Locations
                                <span class="badge bg-secondary ms-1" id="locations-badge">0</span>
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="inventoryTabContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card text-center bg-primary text-white">
                                        <div class="card-body">
                                            <i class="fa fa-archive fa-2x mb-2"></i>
                                            <h4 id="containers-count">Loading...</h4>
                                            <p>Containers</p>
                                            <button class="btn btn-light btn-sm" data-bs-toggle="tab" data-bs-target="#containers">View All</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center bg-info text-white">
                                        <div class="card-body">
                                            <i class="fa fa-folder fa-2x mb-2"></i>
                                            <h4 id="files-count">Loading...</h4>
                                            <p>File Folders</p>
                                            <button class="btn btn-light btn-sm" data-bs-toggle="tab" data-bs-target="#files">View All</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center bg-success text-white">
                                        <div class="card-body">
                                            <i class="fa fa-file-text fa-2x mb-2"></i>
                                            <h4 id="documents-count">Loading...</h4>
                                            <p>Documents</p>
                                            <button class="btn btn-light btn-sm" data-bs-toggle="tab" data-bs-target="#documents">View All</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center bg-warning text-white">
                                        <div class="card-body">
                                            <i class="fa fa-clock-o fa-2x mb-2"></i>
                                            <h4 id="temp-count">Loading...</h4>
                                            <p>Temp Items</p>
                                            <button class="btn btn-light btn-sm" data-bs-toggle="tab" data-bs-target="#temp">View All</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Second Row: Locations Card -->
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <div class="card text-center bg-secondary text-white">
                                        <div class="card-body">
                                            <i class="fa fa-map-marker fa-2x mb-2"></i>
                                            <h4 id="locations-count">Loading...</h4>
                                            <p>My Locations</p>
                                            <small class="d-block mb-2">Organize by floor, room, department</small>
                                            <button class="btn btn-light btn-sm" data-bs-toggle="tab" data-bs-target="#locations">Manage Locations</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recent Activity -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5><i class="fa fa-clock-o"></i> Recent Activity</h5>
                                </div>
                                <div class="card-body" id="recent-activity">
                                    Loading recent activity...
                                </div>
                            </div>
                        </div>

                        <!-- Containers Tab -->
                        <div class="tab-pane fade" id="containers" role="tabpanel">
                            <iframe id="containers-frame" src="/my/inventory/containers" style="width: 100%; height: 800px; border: none;"></iframe>
                        </div>

                        <!-- Files Tab -->
                        <div class="tab-pane fade" id="files" role="tabpanel">
                            <iframe id="files-frame" src="/my/inventory/files" style="width: 100%; height: 800px; border: none;"></iframe>
                        </div>

                        <!-- Documents Tab -->
                        <div class="tab-pane fade" id="documents" role="tabpanel">
                            <iframe id="documents-frame" src="/my/inventory/documents" style="width: 100%; height: 800px; border: none;"></iframe>
                        </div>

                        <!-- Temp Inventory Tab -->
                        <div class="tab-pane fade" id="temp" role="tabpanel">
                            <iframe id="temp-frame" src="/my/inventory/temp" style="width: 100%; height: 800px; border: none;"></iframe>
                        </div>

                        <!-- Customer Locations Tab (Address/Floor/Room Setup) -->
                        <div class="tab-pane fade" id="locations" role="tabpanel">
                            <iframe id="locations-frame" src="/my/inventory/locations" style="width: 100%; height: 800px; border: none;"></iframe>
                        </div>
                    </div>
                </div>

                <!-- JavaScript for Tab Management (Bootstrap 5 compatible) -->
                <script>
                    // Load counts on page load
                    document.addEventListener('DOMContentLoaded', function() {
                        loadInventoryCounts();
                        loadRecentActivity();
                    });

                    function loadInventoryCounts() {
                        // Load counts for each inventory type
                        fetch('/my/inventory/counts', {
                            method: 'GET',
                            headers: { 'Accept': 'application/json' }
                        })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('containers-count').textContent = data.containers || 0;
                            document.getElementById('files-count').textContent = data.files || 0;
                            document.getElementById('documents-count').textContent = data.documents || 0;
                            document.getElementById('temp-count').textContent = data.temp || 0;
                            document.getElementById('locations-count').textContent = data.locations || 0;
                            // Also update tab badges
                            document.getElementById('containers-badge').textContent = data.containers || 0;
                            document.getElementById('files-badge').textContent = data.files || 0;
                            document.getElementById('documents-badge').textContent = data.documents || 0;
                            document.getElementById('temp-badge').textContent = data.temp || 0;
                            document.getElementById('locations-badge').textContent = data.locations || 0;
                        })
                        .catch(error => {
                            console.error('Error loading counts:', error);
                            document.getElementById('containers-count').textContent = 'Error';
                            document.getElementById('files-count').textContent = 'Error';
                            document.getElementById('documents-count').textContent = 'Error';
                            document.getElementById('temp-count').textContent = 'Error';
                            document.getElementById('locations-count').textContent = 'Error';
                        });
                    }

                    function loadRecentActivity() {
                        fetch('/my/inventory/recent_activity', {
                            method: 'GET',
                            headers: { 'Accept': 'text/html' }
                        })
                        .then(response => response.text())
                        .then(html => {
                            // Extract just the activity content from the response
                            var parser = new DOMParser();
                            var doc = parser.parseFromString(html, 'text/html');
                            var activityContent = doc.querySelector('.activity-list, .table, .alert');
                            if (activityContent) {
                                document.getElementById('recent-activity').innerHTML = activityContent.outerHTML;
                            } else {
                                document.getElementById('recent-activity').innerHTML = '<p class="text-muted">No recent activity found.</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading activity:', error);
                            document.getElementById('recent-activity').innerHTML = '<div class="alert alert-warning">Unable to load recent activity</div>';
                        });
                    }
                </script>

                <!-- Legacy inventory UI used for stable portal functionality (kept for backward compatibility) -->
                <div class="o_portal_inventory highlight-modern" style="display: none;">
                    <!-- NOTE: Legacy inventory UI kept for fallback; will be removed after full parity & QA. -->
                    <!-- Enhanced Search and Filter Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fa fa-search"></i>
                                Search &amp; Filter Inventory
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="search-container row">
                                <div class="col-lg-6 mb-3">
                                    <label for="inventory_search" class="form-label">Search Inventory</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fa fa-search"></i>
                                        </span>
                                        <input type="text" id="inventory_search" class="form-control" 
                                               placeholder="Search any text, field, or action (e.g., 'active boxes' or 'destroy document')"
                                               onkeyup="performSearch(this.value)"/>
                                    </div>
                                </div>
                                <div class="col-lg-3 mb-3">
                                    <label for="filter_type" class="form-label">Filter by Type</label>
                                    <select id="filter_type" class="form-control" onchange="applyFilters()">
                                        <option value="">All Types</option>
                                        <option value="box">Box</option>
                                        <option value="document">Document</option>
                                        <option value="file">File</option>
                                    </select>
                                </div>
                                <div class="col-lg-3 mb-3">
                                    <label for="filter_status" class="form-label">Filter by Status</label>
                                    <select id="filter_status" class="form-control" onchange="applyFilters()">
                                        <option value="">All Statuses</option>
                                        <option value="active">Active</option>
                                        <option value="archived">Archived</option>
                                        <option value="destroyed">Destroyed</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Results Section -->
                    <t t-if="not inventory_records">
                        <div class="alert alert-info text-center">
                            <i class="fa fa-info-circle fa-2x mb-3"></i>
                            <h4>No Inventory Records Found</h4>
                            <p>There are currently no records in your inventory matching the selected criteria.</p>
                            <t t-if="request.env.user.has_group('records_management.group_portal_company_admin') or request.env.user.has_group('records_management.group_portal_department_admin') or request.env.user.has_group('records_management.group_portal_department_user')">
                                <button class="btn btn-primary" onclick="addTempInventory()">
                                    <i class="fa fa-plus"></i> Add New Inventory
                                </button>
                            </t>
                            <t t-else="">
                                <p class="text-muted">
                                    <i class="fa fa-info-circle"></i> 
                                    Contact your administrator to add inventory items.
                                </p>
                            </t>
                        </div>
                    </t>

                    <t t-if="inventory_records">
                        <!-- Multi-select Action Bar -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span id="selected_count" class="badge badge-primary">0 selected</span>
                                        <span class="text-muted ml-2">Total: <t t-esc="len(inventory_records)"/> items</span>
                                    </div>
                                    <div class="btn-group">
                                        <t t-if="request.env.user.has_group('records_management.group_portal_company_admin') or request.env.user.has_group('records_management.group_portal_department_admin') or request.env.user.has_group('records_management.group_portal_department_user')">
                                            <button class="btn btn-success" onclick="addTempInventory()">
                                                <i class="fa fa-plus"></i> Add New Inventory
                                            </button>
                                            <button class="btn btn-warning" onclick="batchToPickup()" disabled="disabled" id="batch_pickup_btn">
                                                <i class="fa fa-truck"></i> Add Selected to Pickup
                                            </button>
                                            <button class="btn btn-danger" onclick="batchAction('destruction')" disabled="disabled" id="batch_destroy_btn">
                                                <i class="fa fa-trash"></i> Request Destruction
                                            </button>
                                        </t>
                                        <t t-else="">
                                            <div class="alert alert-info m-0">
                                                <i class="fa fa-info-circle"></i> 
                                                Contact your administrator for inventory management access.
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Inventory Table -->
                        <div class="card">
                            <div class="table-responsive">
                                <table class="table table-striped multi-select-table mb-0" id="inventory_table">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th width="50">
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" class="custom-control-input" id="select_all" onclick="selectAll()"/>
                                                    <label class="custom-control-label" for="select_all"></label>
                                                </div>
                                            </th>
                                            <th>Reference</th>
                                            <th>Type</th>
                                            <th>Box</th>
                                            <th>Location</th>
                                            <th>Status</th>
                                            <th>Created Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="inventory_records" t-as="record">
                                            <tr t-att-class="'inventory-row ' + ('bg-light-success' if record.get('state') == 'active' else 'bg-light-warning' if record.get('state') == 'archived' else 'bg-light-danger' if record.get('state') == 'destroyed' else '')"
                                                t-att-data-id="record.get('id')" t-att-data-type="record.get('model')" t-att-data-status="record.get('state')">
                                                <td>
                                                    <div class="custom-control custom-checkbox">
                                                        <input type="checkbox" class="custom-control-input item-checkbox" 
                                                               t-att-id="'item_' + str(record.get('id'))" 
                                                               t-att-value="record.get('id')" 
                                                               onchange="updateSelection()"/>
                                                        <label class="custom-control-label" t-att-for="'item_' + str(record.get('id'))"></label>
                                                    </div>
                                                </td>
                                                <td>
                                                    <strong t-esc="record.get('name')"/>
                                                    <br/>
                                                    <small class="text-muted" t-esc="record.get('barcode') or ''"/>
                                                </td>
                                                <td>
                                                    <span class="badge badge-info" t-esc="record.get('description') or record.get('type', '').title()"/>
                                                </td>
                                                <td>
                                                    <span class="text-muted">N/A</span>
                                                </td>
                                                <td>
                                                    <span t-esc="record.get('location') or 'N/A'"/>
                                                </td>
                                                <td>
                                                    <span t-att-class="'badge badge-' + ('success' if record.get('state') == 'active' else 'warning' if record.get('state') == 'archived' else 'danger' if record.get('state') == 'destroyed' else 'secondary')"
                                                          t-esc="(record.get('state') or 'active').replace('_', ' ').title()"/>
                                                </td>
                                                <td>
                                                    <span t-esc="record.get('date')" t-options="{'widget': 'datetime'}"/>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary btn-sm" 
                                                                t-att-onclick="'viewDetails(' + str(record.get('id')) + ')'">
                                                            <i class="fa fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-outline-warning btn-sm" 
                                                                t-att-onclick="'requestPickup(' + str(record.get('id')) + ')'">
                                                            <i class="fa fa-truck"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger btn-sm" 
                                                                t-att-onclick="'requestDestruction(' + str(record.get('id')) + ')'"
                                                                t-if="record.get('active', True)">
                                                            <i class="fa fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </t>
                </div>

                <!-- New: My Visit History Section (Integrated for self-service auditing) -->
                <!-- Only show if Frontdesk module is installed -->
                <t t-if="'frontdesk.visitor' in request.env">
                    <div class="o_portal_visit_history mt-5">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fa fa-calendar-check"></i>
                                    My Visit History
                                </h5>
                            </div>
                            <div class="card-body">
                                <p>View your past visits, linked shred transactions, and download destruction certificates for NAID compliance.</p>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>Visit Date</th>
                                                <th>Service</th>
                                                <th>Transaction</th>
                                                <th>Certificate</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="request.env['frontdesk.visitor'].search([('partner_id', '=', request.env.user.partner_id.id)])" t-as="visit">
                                                <tr>
                                                    <td><t t-esc="visit.check_in.strftime('%Y-%m-%d %H:%M') if visit.check_in else '-'"/></td>
                                                    <td>
                                                        <t t-if="visit.is_shred_customer">
                                                            <span class="badge badge-success">Shredding Service</span>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="badge badge-secondary">General Visit</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <t t-if="visit.pos_order_id">
                                                            <a t-attf-href="/my/orders/#{visit.pos_order_id.id}"><t t-esc="visit.pos_order_id.name"/></a>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="text-muted">No Transaction</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <t t-if="visit.pos_order_id">
                                                            <a t-attf-href="/my/certificates/#{visit.id}" class="btn btn-sm btn-primary">
                                                                <i class="fa fa-download"></i> Download Certificate
                                                            </a>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="text-muted">N/A</span>
                                                        </t>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary" t-attf-onclick="window.location.href='/my/schedule-visit'">Schedule a Visit</button>
                                </div>
                                <!-- Modern Filter for Visits -->
                                <div class="form-group mt-3">
                                    <label for="date_filter">Filter by Date:</label>
                                    <input type="date" id="date_filter" class="form-control" placeholder="Select date" onchange="filterVisitsByDate(this.value)"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>

                <!-- Removed inline legacy JS: visit date filter and inventory init now handled via Owl component & future dedicated module. -->
            </t>
        </template>

        <!-- Enhanced Billing Template with PO Updates -->
        <template id="portal_billing" name="My Billing">
            <t t-call="portal.portal_layout">
                <t t-set="title">My Billing</t>
                
                <div class="o_portal_billing">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fa fa-credit-card"></i>
                                Invoice Management
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Invoice #</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>PO Number</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="invoices" t-as="inv">
                                            <tr>
                                                <td>
                                                    <strong t-esc="inv.name"/>
                                                    <br/>
                                                    <small class="text-muted" t-esc="inv.reference or ''"/>
                                                </td>
                                                <td t-esc="inv.invoice_date" t-options="{'widget': 'date'}"/>
                                                <td>
                                                    <span t-esc="inv.amount_total" t-options="{'widget': 'monetary'}"/>
                                                </td>
                                                <td>
                                                    <div class="input-group input-group-sm">
                                                        <input type="text" class="form-control" 
                                                               placeholder="Update PO#" 
                                                               t-att-value="inv.ref or ''"
                                                               t-att-data-invoice-id="inv.id"/>
                                                        <div class="input-group-append">
                                                            <button class="btn btn-outline-primary" 
                                                                    t-att-onclick="'updatePO(' + str(inv.id) + ')'">
                                                                <i class="fa fa-save"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span t-att-class="'badge badge-' + ('success' if inv.payment_state == 'paid' else 'warning')"
                                                          t-esc="inv.payment_state.replace('_', ' ').title()"/>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <a t-attf-href="/my/invoices/#{inv.id}" class="btn btn-outline-primary">
                                                            <i class="fa fa-eye"></i>
                                                        </a>
                                                        <button class="btn btn-outline-warning" 
                                                                t-att-onclick="'requestChange(' + str(inv.id) + ')'">
                                                            <i class="fa fa-edit"></i> Request Change
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </template>

        <!-- Enhanced Quotes Template -->
        <template id="portal_quotes" name="Generate Quotes">
            <t t-call="portal.portal_layout">
                <t t-set="title">Generate Quote</t>
                
                <div class="o_portal_quotes">
                    <div class="row">
                        <!-- Quote Generator Form -->
                        <div class="col-lg-8">
                            <div class="card mb-4">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="fa fa-calculator"></i>
                                        Quote Generator
                                        <t t-if="has_negotiated_rates">
                                            <span class="badge bg-success ms-2">
                                                <i class="fa fa-star"></i> Negotiated Rates Applied
                                            </span>
                                        </t>
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form id="quote_form" method="post" action="/my/quotes/generate">
                                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                        
                                        <!-- Company/Department Info -->
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="company" class="form-label">Company</label>
                                                <input type="text" id="company" name="company" class="form-control" 
                                                       t-att-value="partner.name" readonly="readonly"/>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="department" class="form-label">Department</label>
                                                <input type="text" id="department" name="department" class="form-control" 
                                                       t-att-value="partner.department_id.name if hasattr(partner, 'department_id') and partner.department_id else ''"/>
                                            </div>
                                        </div>

                                        <div id="quote_lines">
                                            <!-- First line by default -->
                                            <div class="quote-line row mb-3 align-items-end" data-line="1">
                                                <div class="col-md-4">
                                                    <label class="form-label">Service Type</label>
                                                    <select class="form-select service-type" name="line_type_1" onchange="updateBinSizeVisibility(this)">
                                                        <option value="">-- Select Service --</option>
                                                        <optgroup label="Shredding Services">
                                                            <option value="shredding">Shredding Bin Service</option>
                                                        </optgroup>
                                                        <optgroup label="Other Services">
                                                            <t t-foreach="service_prices" t-as="svc">
                                                                <option t-att-value="svc['code']" 
                                                                        t-att-data-price="svc['price']"
                                                                        t-att-data-negotiated="'1' if svc['is_negotiated'] else '0'">
                                                                    <t t-esc="svc['name']"/> - <t t-esc="currency_symbol"/><t t-esc="'%.2f' % svc['price']"/>
                                                                    <t t-if="svc['is_negotiated']"> ★</t>
                                                                </option>
                                                            </t>
                                                        </optgroup>
                                                    </select>
                                                </div>
                                                <div class="col-md-3 bin-size-col" style="display: none;">
                                                    <label class="form-label">Bin Size</label>
                                                    <select class="form-select bin-size" name="line_bin_size_1">
                                                        <option value="">-- Select Size --</option>
                                                        <t t-foreach="shredding_prices" t-as="bin">
                                                            <option t-att-value="bin['code']" 
                                                                    t-att-data-price="bin['price']"
                                                                    t-att-data-negotiated="'1' if bin['is_negotiated'] else '0'">
                                                                <t t-esc="bin['name']"/> - <t t-esc="currency_symbol"/><t t-esc="'%.2f' % bin['price']"/>
                                                                <t t-if="bin['is_negotiated']"> ★</t>
                                                            </option>
                                                        </t>
                                                    </select>
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label">Quantity</label>
                                                    <input type="number" class="form-control qty-input" name="line_qty_1" 
                                                           min="1" value="1" onchange="updateLineTotal(this)"/>
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label">Line Total</label>
                                                    <div class="line-total fw-bold text-primary">
                                                        <t t-esc="currency_symbol"/>0.00
                                                    </div>
                                                </div>
                                                <div class="col-md-1">
                                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLine(this)" title="Remove line">
                                                        <i class="fa fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-3">
                                            <div class="col-md-8">
                                                <button type="button" class="btn btn-secondary" onclick="addQuoteLine()">
                                                    <i class="fa fa-plus"></i> Add Line
                                                </button>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <div class="h5 mb-0">
                                                    Estimated Total: <span id="quote-total" class="text-primary"><t t-esc="currency_symbol"/>0.00</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <hr/>
                                        
                                        <div class="text-center mt-4">
                                            <button type="submit" class="btn btn-primary btn-lg">
                                                <i class="fa fa-file-pdf-o"></i> Generate PDF Quote
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sidebar: Pricing Info + Recent Quotes -->
                        <div class="col-lg-4">
                            <!-- Your Pricing Card -->
                            <div class="card mb-4">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="fa fa-tag"></i> Your Pricing
                                        <t t-if="has_negotiated_rates">
                                            <span class="badge bg-warning text-dark ms-1">Special Rates</span>
                                        </t>
                                    </h6>
                                </div>
                                <div class="card-body p-2">
                                    <!-- Shredding Prices -->
                                    <h6 class="text-muted small mb-2">Shredding Bins</h6>
                                    <table class="table table-sm table-borderless mb-3">
                                        <t t-foreach="shredding_prices" t-as="bin">
                                            <tr>
                                                <td class="small"><t t-esc="bin['name']"/></td>
                                                <td class="text-end small">
                                                    <t t-esc="currency_symbol"/><t t-esc="'%.2f' % bin['price']"/>
                                                    <t t-if="bin['is_negotiated']">
                                                        <span class="badge bg-success" title="Negotiated Rate">★</span>
                                                    </t>
                                                </td>
                                            </tr>
                                        </t>
                                    </table>
                                    
                                    <!-- Service Prices -->
                                    <h6 class="text-muted small mb-2">Services</h6>
                                    <table class="table table-sm table-borderless mb-0">
                                        <t t-foreach="service_prices" t-as="svc">
                                            <tr>
                                                <td class="small"><t t-esc="svc['name']"/></td>
                                                <td class="text-end small">
                                                    <t t-esc="currency_symbol"/><t t-esc="'%.2f' % svc['price']"/>
                                                    <t t-if="svc['is_negotiated']">
                                                        <span class="badge bg-success" title="Negotiated Rate">★</span>
                                                    </t>
                                                </td>
                                            </tr>
                                        </t>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Recent Quotes -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fa fa-history"></i> Recent Quotes</h6>
                                </div>
                                <div class="card-body">
                                    <t t-if="recent_quotes">
                                        <t t-foreach="recent_quotes" t-as="quote">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <a t-attf-href="/my/orders/#{quote.id}" class="text-decoration-none">
                                                    <small t-esc="quote.name"/>
                                                </a>
                                                <small class="text-muted"><t t-esc="quote.date_order.strftime('%m/%d/%y') if quote.date_order else ''"/></small>
                                            </div>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted small mb-0">No recent quotes</p>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quote JavaScript -->
                <script>
                    var lineCounter = 1;
                    var currencySymbol = '<t t-esc="currency_symbol"/>';
                    
                    function updateBinSizeVisibility(select) {
                        var line = select.closest('.quote-line');
                        var binSizeCol = line.querySelector('.bin-size-col');
                        if (select.value === 'shredding') {
                            binSizeCol.style.display = 'block';
                        } else {
                            binSizeCol.style.display = 'none';
                            line.querySelector('.bin-size').value = '';
                        }
                        updateLineTotal(select);
                    }
                    
                    function updateLineTotal(element) {
                        var line = element.closest('.quote-line');
                        var serviceSelect = line.querySelector('.service-type');
                        var binSelect = line.querySelector('.bin-size');
                        var qtyInput = line.querySelector('.qty-input');
                        var totalDiv = line.querySelector('.line-total');
                        
                        var price = 0;
                        if (serviceSelect.value === 'shredding' &amp;&amp; binSelect.value) {
                            var option = binSelect.options[binSelect.selectedIndex];
                            price = parseFloat(option.dataset.price || 0);
                        } else if (serviceSelect.value) {
                            var option = serviceSelect.options[serviceSelect.selectedIndex];
                            price = parseFloat(option.dataset.price || 0);
                        }
                        
                        var qty = parseInt(qtyInput.value) || 0;
                        var total = price * qty;
                        totalDiv.textContent = currencySymbol + total.toFixed(2);
                        
                        updateQuoteTotal();
                    }
                    
                    function updateQuoteTotal() {
                        var totalDivs = document.querySelectorAll('.line-total');
                        var grandTotal = 0;
                        totalDivs.forEach(function(div) {
                            var text = div.textContent.replace(currencySymbol, '');
                            grandTotal += parseFloat(text) || 0;
                        });
                        document.getElementById('quote-total').textContent = currencySymbol + grandTotal.toFixed(2);
                    }
                    
                    function addQuoteLine() {
                        lineCounter++;
                        var container = document.getElementById('quote_lines');
                        var firstLine = container.querySelector('.quote-line');
                        var newLine = firstLine.cloneNode(true);
                        
                        newLine.setAttribute('data-line', lineCounter);
                        newLine.querySelector('.service-type').name = 'line_type_' + lineCounter;
                        newLine.querySelector('.service-type').value = '';
                        newLine.querySelector('.bin-size').name = 'line_bin_size_' + lineCounter;
                        newLine.querySelector('.bin-size').value = '';
                        newLine.querySelector('.bin-size-col').style.display = 'none';
                        newLine.querySelector('.qty-input').name = 'line_qty_' + lineCounter;
                        newLine.querySelector('.qty-input').value = 1;
                        newLine.querySelector('.line-total').textContent = currencySymbol + '0.00';
                        
                        container.appendChild(newLine);
                    }
                    
                    function removeLine(button) {
                        var lines = document.querySelectorAll('.quote-line');
                        if (lines.length > 1) {
                            button.closest('.quote-line').remove();
                            updateQuoteTotal();
                        }
                    }
                </script>
            </t>
        </template>

        <!-- NOTE: portal_requests removed 2025-12-04 - Use portal_requests_template in portal_requests_template.xml -->
        
        <!-- Enhanced User Management Template -->
        <template id="portal_users" name="User Management">
            <t t-call="portal.portal_layout">
                <t t-set="title">Manage Users</t>
                
                <div class="o_portal_users">
                    <!-- Bulk Import Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fa fa-upload"></i>
                                Bulk User Import
                            </h5>
                        </div>
                        <div class="card-body">
                            <form action="/my/users/import" method="post" enctype="multipart/form-data">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label for="user_file">CSV File</label>
                                            <input type="file" name="file" id="user_file" class="form-control-file" accept=".csv" required="required"/>
                                            <small class="form-text text-muted">
                                                Upload a CSV file with columns: name, email, department, access_level
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>&#160;</label>
                                            <button type="submit" class="btn btn-primary btn-block">
                                                <i class="fa fa-upload"></i> Import Users
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            </form>
                        </div>
                    </div>

                    <!-- User Management Table -->
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">
                                <i class="fa fa-users"></i>
                                Current Users
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Access Level</th>
                                            <th>Department</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="users" t-as="user">
                                            <tr>
                                                <td>
                                                    <strong t-esc="user.name"/>
                                                </td>
                                                <td t-esc="user.email"/>
                                                <td>
                                                    <select class="form-control form-control-sm" 
                                                            t-att-onchange="'updateAccess(' + str(user.id) + ', this.value)'">
                                                        <option value="viewer" 
                                                                t-att-selected="'selected' if user.access_level == 'viewer' else None">
                                                            Viewer
                                                        </option>
                                                        <option value="editor" 
                                                                t-att-selected="'selected' if user.access_level == 'editor' else None">
                                                            Editor
                                                        </option>
                                                        <option value="admin" 
                                                                t-att-selected="'selected' if user.access_level == 'admin' else None">
                                                            Admin
                                                        </option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <select class="form-control form-control-sm" 
                                                            t-att-onchange="'updateDept(' + str(user.id) + ', this.value)'">
                                                        <option value="">Select Department</option>
                                                        <t t-foreach="departments" t-as="dept">
                                                            <option t-att-value="dept.id" 
                                                                    t-att-selected="'selected' if user.department_id and user.department_id.id == dept.id else None"
                                                                    t-esc="dept.name"/>
                                                        </t>
                                                    </select>
                                                </td>
                                                <td>
                                                    <span t-att-class="'badge badge-' + ('success' if user.active else 'secondary')"
                                                          t-esc="'Active' if user.active else 'Inactive'"/>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-info" 
                                                                t-att-onclick="'editUser(' + str(user.id) + ')'">
                                                            <i class="fa fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger" 
                                                                t-att-onclick="'deactivateUser(' + str(user.id) + ')'"
                                                                t-if="user.active">
                                                            <i class="fa fa-ban"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </template>
    </data>
    </odoo>
