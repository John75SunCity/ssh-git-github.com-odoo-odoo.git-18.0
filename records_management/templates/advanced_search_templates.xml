<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Advanced Inventory Search Page -->
    <template id="portal_advanced_inventory_search" name="Advanced Inventory Search">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Advanced Physical Inventory Search</t>
            </t>
            
            <div class="o_portal_my_home">
                <div class="oe_structure">
                    <div class="container">
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <h3 class="mb-0">
                                            <i class="fa fa-search"/> Advanced Physical Inventory Search
                                        </h3>
                                        <p class="mb-0 small">Search across containers, file folders, and documents</p>
                                    </div>
                                    
                                    <div class="card-body">
                                        <!-- Search Form -->
                                        <form method="GET" action="/my/inventory/advanced_search" id="advancedSearchForm">
                                            <div class="row">
                                                <!-- Barcode Search -->
                                                <div class="col-md-6 mb-3">
                                                    <label for="barcode" class="form-label">
                                                        <i class="fa fa-barcode"/> Barcode / ID
                                                    </label>
                                                    <input type="text" 
                                                           class="form-control" 
                                                           id="barcode" 
                                                           name="barcode" 
                                                           placeholder="Enter barcode or ID"
                                                           t-att-value="barcode or ''"/>
                                                    <small class="form-text text-muted">Search by container, folder, or document barcode</small>
                                                </div>
                                                
                                                <!-- Location Search -->
                                                <div class="col-md-6 mb-3">
                                                    <label for="location" class="form-label">
                                                        <i class="fa fa-map-marker"/> Location
                                                    </label>
                                                    <input type="text" 
                                                           class="form-control" 
                                                           id="location" 
                                                           name="location" 
                                                           placeholder="Warehouse location"
                                                           t-att-value="location or ''"/>
                                                    <small class="form-text text-muted">Physical warehouse location code</small>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <!-- Date Range -->
                                                <div class="col-md-3 mb-3">
                                                    <label for="date_from" class="form-label">
                                                        <i class="fa fa-calendar"/> Date From
                                                    </label>
                                                    <input type="date" 
                                                           class="form-control" 
                                                           id="date_from" 
                                                           name="date_from"
                                                           t-att-value="date_from or ''"/>
                                                </div>
                                                
                                                <div class="col-md-3 mb-3">
                                                    <label for="date_to" class="form-label">
                                                        <i class="fa fa-calendar"/> Date To
                                                    </label>
                                                    <input type="date" 
                                                           class="form-control" 
                                                           id="date_to" 
                                                           name="date_to"
                                                           t-att-value="date_to or ''"/>
                                                </div>
                                                
                                                <!-- Record Type -->
                                                <div class="col-md-3 mb-3">
                                                    <label for="record_type" class="form-label">
                                                        <i class="fa fa-folder"/> Record Type
                                                    </label>
                                                    <select class="form-control" id="record_type" name="record_type">
                                                        <option value="">All Types</option>
                                                        <option value="container" t-att-selected="'selected' if record_type == 'container' else None">
                                                            Containers (Physical Boxes)
                                                        </option>
                                                        <option value="file_folder" t-att-selected="'selected' if record_type == 'file_folder' else None">
                                                            File Folders
                                                        </option>
                                                        <option value="document" t-att-selected="'selected' if record_type == 'document' else None">
                                                            Documents
                                                        </option>
                                                    </select>
                                                </div>
                                                
                                                <!-- State Filter -->
                                                <div class="col-md-3 mb-3">
                                                    <label for="state" class="form-label">
                                                        <i class="fa fa-flag"/> Status
                                                    </label>
                                                    <select class="form-control" id="state" name="state">
                                                        <option value="">All Statuses</option>
                                                        <option value="in_storage" t-att-selected="'selected' if state == 'in_storage' else None">
                                                            In Storage
                                                        </option>
                                                        <option value="retrieved" t-att-selected="'selected' if state == 'retrieved' else None">
                                                            Retrieved
                                                        </option>
                                                        <option value="pending_destruction" t-att-selected="'selected' if state == 'pending_destruction' else None">
                                                            Pending Destruction
                                                        </option>
                                                        <option value="destroyed" t-att-selected="'selected' if state == 'destroyed' else None">
                                                            Destroyed
                                                        </option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <!-- Document Type (for physical documents) -->
                                                <div class="col-md-6 mb-3">
                                                    <label for="document_type" class="form-label">
                                                        <i class="fa fa-file-text"/> Document Category
                                                    </label>
                                                    <select class="form-control" id="document_type" name="document_type">
                                                        <option value="">All Categories</option>
                                                        <t t-foreach="document_types or []" t-as="doc_type">
                                                            <option t-att-value="doc_type.id" 
                                                                    t-att-selected="'selected' if document_type == str(doc_type.id) else None"
                                                                    t-esc="doc_type.name"/>
                                                        </t>
                                                    </select>
                                                    <small class="form-text text-muted">Category of physical documents</small>
                                                </div>
                                                
                                                <!-- Retention Status -->
                                                <div class="col-md-6 mb-3">
                                                    <label for="retention_status" class="form-label">
                                                        <i class="fa fa-clock-o"/> Retention Status
                                                    </label>
                                                    <select class="form-control" id="retention_status" name="retention_status">
                                                        <option value="">All</option>
                                                        <option value="active" t-att-selected="'selected' if retention_status == 'active' else None">
                                                            Active Retention
                                                        </option>
                                                        <option value="eligible" t-att-selected="'selected' if retention_status == 'eligible' else None">
                                                            Eligible for Destruction
                                                        </option>
                                                        <option value="permanent" t-att-selected="'selected' if retention_status == 'permanent' else None">
                                                            Permanent Storage
                                                        </option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <!-- Action Buttons -->
                                            <div class="row mt-3">
                                                <div class="col-12">
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fa fa-search"/> Search Inventory
                                                    </button>
                                                    <button type="button" class="btn btn-secondary ms-2" onclick="clearSearchForm()">
                                                        <i class="fa fa-eraser"/> Clear Filters
                                                    </button>
                                                    <button type="button" class="btn btn-info ms-2" data-bs-toggle="modal" data-bs-target="#saveSearchModal">
                                                        <i class="fa fa-save"/> Save Search Preset
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                        
                                        <!-- Saved Search Presets -->
                                        <t t-if="saved_searches">
                                            <div class="row mt-4">
                                                <div class="col-12">
                                                    <h5><i class="fa fa-star"/> Saved Search Presets</h5>
                                                    <div class="btn-group" role="group">
                                                        <t t-foreach="saved_searches" t-as="search">
                                                            <button type="button" 
                                                                    class="btn btn-outline-primary btn-sm"
                                                                    onclick="loadSearchPreset(this)"
                                                                    t-att-data-filters="search.filters"
                                                                    t-att-data-search-id="search.id">
                                                                <i class="fa fa-star" t-if="search.is_default"/>
                                                                <i class="fa fa-star-o" t-else=""/>
                                                                <span t-esc="search.name"/>
                                                                <small class="text-muted" t-if="search.usage_count">
                                                                    (used <span t-esc="search.usage_count"/> times)
                                                                </small>
                                                            </button>
                                                        </t>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Search Results -->
                        <t t-if="search_results">
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            <h4 class="mb-0">
                                                <i class="fa fa-list"/> Search Results
                                                <span class="badge bg-light text-dark ms-2">
                                                    <span t-esc="len(search_results.get('containers', []))"/> Containers, 
                                                    <span t-esc="len(search_results.get('file_folders', []))"/> File Folders, 
                                                    <span t-esc="len(search_results.get('documents', []))"/> Documents
                                                </span>
                                            </h4>
                                        </div>
                                        
                                        <div class="card-body">
                                            <!-- Export Options -->
                                            <div class="mb-3">
                                                <a t-attf-href="/my/inventory/export?format=excel&amp;{{ keep_query() }}" 
                                                   class="btn btn-success btn-sm">
                                                    <i class="fa fa-file-excel-o"/> Export to Excel
                                                </a>
                                                <a t-attf-href="/my/inventory/export?format=csv&amp;{{ keep_query() }}" 
                                                   class="btn btn-success btn-sm ms-2">
                                                    <i class="fa fa-file-text-o"/> Export to CSV
                                                </a>
                                                <a t-attf-href="/my/inventory/export?format=pdf&amp;{{ keep_query() }}" 
                                                   class="btn btn-danger btn-sm ms-2">
                                                    <i class="fa fa-file-pdf-o"/> Export to PDF
                                                </a>
                                            </div>
                                            
                                            <!-- Results Tabs -->
                                            <ul class="nav nav-tabs" role="tablist">
                                                <li class="nav-item">
                                                    <a class="nav-link active" data-bs-toggle="tab" href="#containers-tab">
                                                        <i class="fa fa-archive"/> Containers (<span t-esc="len(search_results.get('containers', []))"/>)
                                                    </a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" data-bs-toggle="tab" href="#folders-tab">
                                                        <i class="fa fa-folder"/> File Folders (<span t-esc="len(search_results.get('file_folders', []))"/>)
                                                    </a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" data-bs-toggle="tab" href="#documents-tab">
                                                        <i class="fa fa-file-text"/> Documents (<span t-esc="len(search_results.get('documents', []))"/>)
                                                    </a>
                                                </li>
                                            </ul>
                                            
                                            <div class="tab-content mt-3">
                                                <!-- Containers Tab -->
                                                <div id="containers-tab" class="tab-pane fade show active">
                                                    <t t-if="search_results.get('containers')">
                                                        <table class="table table-striped table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>Barcode</th>
                                                                    <th>Location</th>
                                                                    <th>Status</th>
                                                                    <th>Contents</th>
                                                                    <th>Date Received</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <t t-foreach="search_results['containers']" t-as="container">
                                                                    <tr>
                                                                        <td><strong t-esc="container.barcode or container.name"/></td>
                                                                        <td><span t-esc="container.location_id.name if container.location_id else 'Not Assigned'"/></td>
                                                                        <td>
                                                                            <span class="badge" 
                                                                                  t-att-class="'bg-success' if container.state == 'in' else 'bg-warning' if container.state == 'pending' else 'bg-info'"
                                                                                  t-esc="container.state_display or 'Pending'"/>
                                                                        </td>
                                                                        <td><span t-esc="container.file_folder_count or 0"/> folders</td>
                                                                        <td><span t-esc="container.received_date.strftime('%m/%d/%Y') if container.received_date else 'N/A'"/></td>
                                                                        <td>
                                                                            <a t-attf-href="/my/containers/{{ container.id }}" class="btn btn-sm btn-primary">
                                                                                <i class="fa fa-eye"/> View
                                                                            </a>
                                                                        </td>
                                                                    </tr>
                                                                </t>
                                                            </tbody>
                                                        </table>
                                                    </t>
                                                    <t t-else="">
                                                        <p class="text-muted"><i class="fa fa-info-circle"/> No containers match your search criteria.</p>
                                                    </t>
                                                </div>
                                                
                                                <!-- File Folders Tab -->
                                                <div id="folders-tab" class="tab-pane fade">
                                                    <t t-if="search_results.get('file_folders')">
                                                        <table class="table table-striped table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>Folder ID</th>
                                                                    <th>Container</th>
                                                                    <th>Description</th>
                                                                    <th>Documents</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <t t-foreach="search_results['file_folders']" t-as="folder">
                                                                    <tr>
                                                                        <td><strong t-esc="folder.folder_id or folder.name"/></td>
                                                                        <td><span t-esc="folder.container_id.barcode if folder.container_id else 'N/A'"/></td>
                                                                        <td><span t-esc="folder.description or 'No description'"/></td>
                                                                        <td><span t-esc="folder.document_count or 0"/> docs</td>
                                                                        <td>
                                                                            <a t-attf-href="/my/folders/{{ folder.id }}" class="btn btn-sm btn-primary">
                                                                                <i class="fa fa-eye"/> View
                                                                            </a>
                                                                        </td>
                                                                    </tr>
                                                                </t>
                                                            </tbody>
                                                        </table>
                                                    </t>
                                                    <t t-else="">
                                                        <p class="text-muted"><i class="fa fa-info-circle"/> No file folders match your search criteria.</p>
                                                    </t>
                                                </div>
                                                
                                                <!-- Documents Tab -->
                                                <div id="documents-tab" class="tab-pane fade">
                                                    <t t-if="search_results.get('documents')">
                                                        <table class="table table-striped table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>Document ID</th>
                                                                    <th>Type</th>
                                                                    <th>File Folder</th>
                                                                    <th>Container</th>
                                                                    <th>Date</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <t t-foreach="search_results['documents']" t-as="doc">
                                                                    <tr>
                                                                        <td><strong t-esc="doc.document_id or doc.name"/></td>
                                                                        <td><span t-esc="doc.document_type_id.name if doc.document_type_id else 'N/A'"/></td>
                                                                        <td><span t-esc="doc.file_folder_id.folder_id if doc.file_folder_id else 'N/A'"/></td>
                                                                        <td><span t-esc="doc.container_id.barcode if doc.container_id else 'N/A'"/></td>
                                                                        <td><span t-esc="doc.document_date.strftime('%m/%d/%Y') if doc.document_date else 'N/A'"/></td>
                                                                        <td>
                                                                            <a t-attf-href="/my/documents/{{ doc.id }}" class="btn btn-sm btn-primary">
                                                                                <i class="fa fa-eye"/> View
                                                                            </a>
                                                                        </td>
                                                                    </tr>
                                                                </t>
                                                            </tbody>
                                                        </table>
                                                    </t>
                                                    <t t-else="">
                                                        <p class="text-muted"><i class="fa fa-info-circle"/> No documents match your search criteria.</p>
                                                    </t>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </div>
            </div>
            
            <!-- Save Search Modal -->
            <div class="modal fade" id="saveSearchModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Save Search Preset</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"/>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="search_name" class="form-label">Preset Name</label>
                                <input type="text" class="form-control" id="search_name" placeholder="e.g., Active Containers in Warehouse A"/>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_default"/>
                                <label class="form-check-label" for="is_default">
                                    Set as my default search
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveSearchPreset()">
                                <i class="fa fa-save"/> Save Preset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- JavaScript for Search Functionality -->
            <script>
                function clearSearchForm() {
                    document.getElementById('advancedSearchForm').reset();
                    window.location.href = '/my/inventory/advanced_search';
                }
                
                function loadSearchPreset(button) {
                    const filters = JSON.parse(button.dataset.filters);
                    const searchId = button.dataset.searchId;
                    
                    // Populate form with saved filters
                    Object.keys(filters).forEach(key => {
                        const input = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                        if (input) {
                            input.value = filters[key];
                        }
                    });
                    
                    // Submit form
                    document.getElementById('advancedSearchForm').submit();
                }
                
                async function saveSearchPreset() {
                    const name = document.getElementById('search_name').value;
                    const isDefault = document.getElementById('is_default').checked;
                    
                    if (!name) {
                        alert('Please enter a name for this search preset');
                        return;
                    }
                    
                    // Gather current filter values
                    const form = document.getElementById('advancedSearchForm');
                    const formData = new FormData(form);
                    const filters = {};
                    
                    for (let [key, value] of formData.entries()) {
                        if (value) {
                            filters[key] = value;
                        }
                    }
                    
                    try {
                        const response = await fetch('/my/inventory/save_search', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                jsonrpc: '2.0',
                                method: 'call',
                                params: {
                                    name: name,
                                    filters: filters,
                                    is_default: isDefault
                                }
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.result &amp;&amp; result.result.success) {
                            alert('Search preset saved successfully!');
                            window.location.reload();
                        } else {
                            alert('Error saving search preset: ' + (result.error || 'Unknown error'));
                        }
                    } catch (error) {
                        alert('Error saving search preset: ' + error.message);
                    }
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('saveSearchModal'));
                    modal.hide();
                }
            </script>
        </t>
    </template>
</odoo>
