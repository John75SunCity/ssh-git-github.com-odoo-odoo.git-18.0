<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="portal_barcode_template" name="Portal Barcode Template">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-set="pageName" t-value="'barcode'"/>
            <t t-set="title">Barcode Management</t>

            <div class="container-fluid">
                <!-- Barcode Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h4 class="mb-0">
                                            <i class="fa fa-barcode me-2"></i>
                                            Barcode Management
                                        </h4>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <button class="btn btn-primary" onclick="generateNewBarcode()">
                                            <i class="fa fa-plus me-2"></i>Generate Barcode
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Barcode Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <div class="h1 text-primary mb-2" t-esc="barcode_stats.total or 0"/>
                                <h5 class="card-title">Total Barcodes</h5>
                                <p class="card-text text-muted">Active barcodes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <div class="h1 text-success mb-2" t-esc="barcode_stats.generated_today or 0"/>
                                <h5 class="card-title">Generated Today</h5>
                                <p class="card-text text-muted">New barcodes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <div class="h1 text-info mb-2" t-esc="barcode_stats.scanned_today or 0"/>
                                <h5 class="card-title">Scanned Today</h5>
                                <p class="card-text text-muted">Usage count</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <div class="h1 text-warning mb-2" t-esc="barcode_stats.expired or 0"/>
                                <h5 class="card-title">Expired</h5>
                                <p class="card-text text-muted">Need renewal</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Barcode Search and Filter -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="barcodeSearch" placeholder="Search by barcode, container, or location..." onkeyup="filterBarcodes()"/>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="barcodeTypeFilter" onchange="filterBarcodes()">
                                            <option value="">All Types</option>
                                            <option value="container">Container</option>
                                            <option value="location">Location</option>
                                            <option value="document">Document</option>
                                            <option value="box">Storage Box</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="barcodeStatusFilter" onchange="filterBarcodes()">
                                            <option value="">All Status</option>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                            <option value="expired">Expired</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                            <i class="fa fa-times me-1"></i>Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Barcode List -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fa fa-list me-2"></i>
                                    Barcode Inventory
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="barcodeTable">
                                        <thead>
                                            <tr>
                                                <th>Barcode</th>
                                                <th>Type</th>
                                                <th>Associated Item</th>
                                                <th>Location</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Last Scanned</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="barcodes" t-as="barcode">
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="barcode-display me-3">
                                                                <img t-attf-src="data:image/png;base64,{{ barcode.barcode_image }}" alt="Barcode" class="img-fluid" style="max-height: 40px;"/>
                                                            </div>
                                                            <div>
                                                                <code t-esc="barcode.name"/>
                                                                <br/>
                                                                <small class="text-muted">Format: <t t-esc="barcode.barcode_format"/></small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span t-attf-class="badge {{ barcode.type_badge_class }}">
                                                            <t t-esc="barcode.barcode_type"/>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <t t-if="barcode.container_id">
                                                            <strong>Container:</strong> <t t-esc="barcode.container_id.name"/>
                                                        </t>
                                                        <t t-elif="barcode.location_id">
                                                            <strong>Location:</strong> <t t-esc="barcode.location_id.name"/>
                                                        </t>
                                                        <t t-elif="barcode.document_id">
                                                            <strong>Document:</strong> <t t-esc="barcode.document_id.name"/>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="text-muted">Not assigned</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <t t-if="barcode.current_location">
                                                            <t t-esc="barcode.current_location"/>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="text-muted">-</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <t t-if="barcode.active">
                                                            <span class="badge badge-success">Active</span>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="badge badge-secondary">Inactive</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <t t-esc="barcode.create_date.strftime('%m/%d/%Y')"/>
                                                        <br/>
                                                        <small class="text-muted"><t t-esc="barcode.create_date.strftime('%H:%M')"/></small>
                                                    </td>
                                                    <td>
                                                        <t t-if="barcode.last_scanned">
                                                            <t t-esc="barcode.last_scanned.strftime('%m/%d/%Y')"/>
                                                            <br/>
                                                            <small class="text-muted"><t t-esc="barcode.last_scanned.strftime('%H:%M')"/></small>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="text-muted">Never</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group" role="group">
                                                            <button class="btn btn-sm btn-outline-primary" onclick="printBarcode('barcode.barcode_id')">
                                                                <i class="fa fa-print"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-info" onclick="viewBarcodeDetails('barcode.barcode_id')">
                                                                <i class="fa fa-eye"></i>
                                                            </button>
                                                            <div class="dropdown">
                                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                                    <i class="fa fa-ellipsis-v"></i>
                                                                </button>
                                                                <ul class="dropdown-menu">
                                                                    <li><a class="dropdown-item" href="#" onclick="editBarcode('barcode.barcode_id')">
                                                                        <i class="fa fa-edit me-2"></i>Edit
                                                                    </a></li>
                                                                    <li><a class="dropdown-item" href="#" onclick="duplicateBarcode('barcode.barcode_id')">
                                                                        <i class="fa fa-copy me-2"></i>Duplicate
                                                                    </a></li>
                                                                    <li><hr class="dropdown-divider"/></li>
                                                                    <li><a class="dropdown-item text-danger" href="#" onclick="deactivateBarcode('barcode.barcode_id')">
                                                                        <i class="fa fa-ban me-2"></i>Deactivate
                                                                    </a></li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                <nav aria-label="Barcode pagination" class="mt-3">
                                    <ul class="pagination justify-content-center">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" tabindex="-1">Previous</a>
                                        </li>
                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                                        <li class="page-item">
                                            <a class="page-link" href="#">Next</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Barcode Generation History -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fa fa-history me-2"></i>
                                    Generation History
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Generated By</th>
                                                <th>Type</th>
                                                <th>Count</th>
                                                <th>Purpose</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="generation_history" t-as="history">
                                                <tr>
                                                    <td>
                                                        <t t-esc="history.date.strftime('%m/%d/%Y')"/>
                                                        <br/>
                                                        <small class="text-muted"><t t-esc="history.date.strftime('%H:%M')"/></small>
                                                    </td>
                                                    <td><t t-esc="history.generated_by"/></td>
                                                    <td>
                                                        <span t-attf-class="badge {{ history.type_badge_class }}">
                                                            <t t-esc="history.barcode_type"/>
                                                        </span>
                                                    </td>
                                                    <td><t t-esc="history.count"/></td>
                                                    <td><t t-esc="history.purpose"/></td>
                                                    <td>
                                                        <t t-if="history.success">
                                                            <span class="badge badge-success">Success</span>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="badge badge-danger">Failed</span>
                                                        </t>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Barcode Details Modal -->
            <div class="modal fade" id="barcodeDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Barcode Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Barcode Information</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td class="text-muted">Barcode:</td>
                                            <td><code id="modalBarcode"></code></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Format:</td>
                                            <td id="modalFormat"></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Type:</td>
                                            <td id="modalType"></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Status:</td>
                                            <td id="modalStatus"></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Created:</td>
                                            <td id="modalCreated"></td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Barcode Image</h6>
                                    <div class="text-center">
                                        <img id="modalBarcodeImage" src="" alt="Barcode" class="img-fluid border"/>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-primary btn-sm" onclick="printBarcodeImage()">
                                            <i class="fa fa-print me-1"></i>Print Barcode
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="downloadBarcodeImage()">
                                            <i class="fa fa-download me-1"></i>Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>Scan History</h6>
                                    <div id="scanHistory" class="table-responsive">
                                        <!-- Scan history will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                function generateNewBarcode() {
                    // Implementation for generating new barcode
                    console.log('Generating new barcode...');
                }

                function printBarcode(barcodeId) {
                    // Implementation for printing barcode
                    console.log('Printing barcode:', barcodeId);
                }

                function viewBarcodeDetails(barcodeId) {
                    // Implementation for viewing barcode details
                    console.log('Viewing barcode details:', barcodeId);
                    // Show modal with barcode details
                    $('#barcodeDetailsModal').modal('show');
                }

                function editBarcode(barcodeId) {
                    // Implementation for editing barcode
                    console.log('Editing barcode:', barcodeId);
                }

                function duplicateBarcode(barcodeId) {
                    // Implementation for duplicating barcode
                    console.log('Duplicating barcode:', barcodeId);
                }

                function deactivateBarcode(barcodeId) {
                    // Implementation for deactivating barcode
                    console.log('Deactivating barcode:', barcodeId);
                }

                function filterBarcodes() {
                    // Implementation for filtering barcodes
                    const searchTerm = $('#barcodeSearch').val().toLowerCase();
                    const typeFilter = $('#barcodeTypeFilter').val();
                    const statusFilter = $('#barcodeStatusFilter').val();

                    $('#barcodeTable tbody tr').each(function() {
                        const row = $(this);
                        const barcodeText = row.find('code').text().toLowerCase();
                        const typeText = row.find('td:nth-child(2)').text().toLowerCase();
                        const statusText = row.find('td:nth-child(5)').text().toLowerCase();

                        const matchesSearch = !searchTerm || barcodeText.includes(searchTerm);
                        const matchesType = !typeFilter || typeText.includes(typeFilter.toLowerCase());
                        const matchesStatus = !statusFilter || statusText.includes(statusFilter.toLowerCase());

                        if (matchesSearch &amp;&amp; matchesType &amp;&amp; matchesStatus) {
                            row.show();
                        } else {
                            row.hide();
                        }
                    });
                }

                function clearFilters() {
                    $('#barcodeSearch').val('');
                    $('#barcodeTypeFilter').val('');
                    $('#barcodeStatusFilter').val('');
                    filterBarcodes();
                }

                function printBarcodeImage() {
                    // Implementation for printing barcode image
                    const printWindow = window.open('', '_blank');
                    const barcodeImage = $('#modalBarcodeImage').attr('src');
                    printWindow.document.write('<img src="' + barcodeImage + '" style="max-width: 100%;"/>');
                    printWindow.document.close();
                    printWindow.print();
                }

                function downloadBarcodeImage() {
                    // Implementation for downloading barcode image
                    const link = document.createElement('a');
                    link.href = $('#modalBarcodeImage').attr('src');
                    link.download = 'barcode.png';
                    link.click();
                }
            </script>
        </t>
    </template>
</odoo>
