<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>
        <!-- ===================================================================
             PORTAL WORK ORDER COORDINATOR
             Unified view of all work orders for company/department admins
             =================================================================== -->
        <template id="portal_coordinators_template" name="Work Order Coordinator">
            <t t-call="portal.portal_layout">
                <t t-set="breadcrumbs_searchbar" t-value="True"/>
                <t t-set="title">Work Order Coordinator</t>

                <div class="o_portal_coordinators">
                    <!-- Header -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h3 class="mb-0">
                                <i class="fa fa-sitemap"></i>
                                Work Order Coordinator
                            </h3>
                            <div>
                                <a href="/my/calendar" class="btn btn-outline-light btn-sm">
                                    <i class="fa fa-calendar"></i> Calendar View
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filters and Search -->
                            <form method="get" action="/my/coordinators" class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <label class="form-label">Filter By</label>
                                    <select name="filterby" class="form-control" onchange="this.form.submit()">
                                        <t t-foreach="filter_options" t-as="opt">
                                            <option t-att-value="opt[0]" t-att-selected="filterby == opt[0]">
                                                <t t-esc="opt[1]"/>
                                            </option>
                                        </t>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Sort By</label>
                                    <select name="sortby" class="form-control" onchange="this.form.submit()">
                                        <t t-foreach="sort_options" t-as="opt">
                                            <option t-att-value="opt[0]" t-att-selected="sortby == opt[0]">
                                                <t t-esc="opt[1]"/>
                                            </option>
                                        </t>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Search</label>
                                    <div class="input-group">
                                        <input type="text" name="search" class="form-control" 
                                               placeholder="Search work orders..." t-att-value="search"/>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>

                            <!-- Status Summary Cards -->
                            <div class="row mb-4">
                                <div class="col-md-3 col-6 mb-2">
                                    <div class="card border-warning h-100">
                                        <div class="card-body text-center py-2">
                                            <h5 class="text-warning mb-1">
                                                <i class="fa fa-hourglass-half"></i>
                                            </h5>
                                            <h4 class="mb-0" t-esc="len(state_groups.get('draft', []) + state_groups.get('confirmed', []) + state_groups.get('authorized', []))"/>
                                            <small class="text-muted">Pending</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-2">
                                    <div class="card border-info h-100">
                                        <div class="card-body text-center py-2">
                                            <h5 class="text-info mb-1">
                                                <i class="fa fa-calendar-check-o"></i>
                                            </h5>
                                            <h4 class="mb-0" t-esc="len(state_groups.get('scheduled', []) + state_groups.get('assigned', []))"/>
                                            <small class="text-muted">Scheduled</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-2">
                                    <div class="card border-primary h-100">
                                        <div class="card-body text-center py-2">
                                            <h5 class="text-primary mb-1">
                                                <i class="fa fa-cogs"></i>
                                            </h5>
                                            <h4 class="mb-0" t-esc="len(state_groups.get('in_progress', []))"/>
                                            <small class="text-muted">In Progress</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-2">
                                    <div class="card border-success h-100">
                                        <div class="card-body text-center py-2">
                                            <h5 class="text-success mb-1">
                                                <i class="fa fa-check-circle"></i>
                                            </h5>
                                            <h4 class="mb-0" t-esc="len(state_groups.get('completed', []) + state_groups.get('verified', []) + state_groups.get('certified', []))"/>
                                            <small class="text-muted">Completed</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- View Toggle -->
                    <div class="d-flex justify-content-end mb-3">
                        <div class="btn-group btn-group-sm" role="group" aria-label="View toggle">
                            <button type="button" class="btn btn-outline-secondary view-toggle-btn" onclick="toggleCoordinatorView('kanban')" title="Kanban View">
                                <i class="fa fa-th-large"></i> Kanban
                            </button>
                            <button type="button" class="btn btn-outline-secondary view-toggle-btn active" onclick="toggleCoordinatorView('list')" title="List View">
                                <i class="fa fa-list"></i> List
                            </button>
                        </div>
                    </div>

                    <!-- Kanban View (Hidden by default on mobile) -->
                    <div class="row mb-4 portal-kanban-view d-none" id="kanban-view">
                        <!-- Pending Column -->
                        <div class="col-md-3">
                            <div class="card bg-light h-100">
                                <div class="card-header bg-warning text-dark">
                                    <strong><i class="fa fa-hourglass-half"></i> Pending</strong>
                                </div>
                                <div class="card-body p-2" style="max-height: 500px; overflow-y: auto;">
                                    <t t-foreach="state_groups.get('draft', []) + state_groups.get('confirmed', []) + state_groups.get('authorized', [])" t-as="wo">
                                        <t t-call="records_management.portal_coordinator_kanban_card"/>
                                    </t>
                                    <t t-if="not (state_groups.get('draft', []) + state_groups.get('confirmed', []) + state_groups.get('authorized', []))">
                                        <p class="text-muted text-center py-3">No pending orders</p>
                                    </t>
                                </div>
                            </div>
                        </div>
                        <!-- Scheduled Column -->
                        <div class="col-md-3">
                            <div class="card bg-light h-100">
                                <div class="card-header bg-info text-white">
                                    <strong><i class="fa fa-calendar"></i> Scheduled</strong>
                                </div>
                                <div class="card-body p-2" style="max-height: 500px; overflow-y: auto;">
                                    <t t-foreach="state_groups.get('scheduled', []) + state_groups.get('assigned', [])" t-as="wo">
                                        <t t-call="records_management.portal_coordinator_kanban_card"/>
                                    </t>
                                    <t t-if="not (state_groups.get('scheduled', []) + state_groups.get('assigned', []))">
                                        <p class="text-muted text-center py-3">No scheduled orders</p>
                                    </t>
                                </div>
                            </div>
                        </div>
                        <!-- In Progress Column -->
                        <div class="col-md-3">
                            <div class="card bg-light h-100">
                                <div class="card-header bg-primary text-white">
                                    <strong><i class="fa fa-cogs"></i> In Progress</strong>
                                </div>
                                <div class="card-body p-2" style="max-height: 500px; overflow-y: auto;">
                                    <t t-foreach="state_groups.get('in_progress', [])" t-as="wo">
                                        <t t-call="records_management.portal_coordinator_kanban_card"/>
                                    </t>
                                    <t t-if="not state_groups.get('in_progress', [])">
                                        <p class="text-muted text-center py-3">No orders in progress</p>
                                    </t>
                                </div>
                            </div>
                        </div>
                        <!-- Completed Column -->
                        <div class="col-md-3">
                            <div class="card bg-light h-100">
                                <div class="card-header bg-success text-white">
                                    <strong><i class="fa fa-check"></i> Completed</strong>
                                </div>
                                <div class="card-body p-2" style="max-height: 500px; overflow-y: auto;">
                                    <t t-foreach="state_groups.get('completed', []) + state_groups.get('verified', []) + state_groups.get('certified', [])" t-as="wo">
                                        <t t-call="records_management.portal_coordinator_kanban_card"/>
                                    </t>
                                    <t t-if="not (state_groups.get('completed', []) + state_groups.get('verified', []) + state_groups.get('certified', []))">
                                        <p class="text-muted text-center py-3">No completed orders</p>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- List View (Default) -->
                    <div class="card portal-list-view">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong><i class="fa fa-list"></i> All Work Orders (<t t-esc="work_order_count"/>)</strong>
                        </div>
                        <div class="card-body p-0">
                            <t t-if="work_orders">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Work Order #</th>
                                                <th>Type</th>
                                                <th>Status</th>
                                                <th>Scheduled</th>
                                                <th>Priority</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="work_orders" t-as="wo">
                                                <tr>
                                                    <td>
                                                        <strong t-esc="wo.display_name or wo.name"/>
                                                    </td>
                                                    <td>
                                                        <t t-if="wo.work_order_type == 'retrieval'">
                                                            <span class="badge bg-success"><i class="fa fa-download"></i> Retrieval</span>
                                                        </t>
                                                        <t t-elif="wo.work_order_type == 'shredding'">
                                                            <span class="badge bg-danger"><i class="fa fa-cut"></i> Shredding</span>
                                                        </t>
                                                        <t t-elif="wo.work_order_type == 'pickup'">
                                                            <span class="badge bg-primary"><i class="fa fa-truck"></i> Pickup</span>
                                                        </t>
                                                        <t t-elif="wo.work_order_type == 'container_destruction'">
                                                            <span class="badge bg-dark"><i class="fa fa-trash"></i> Destruction</span>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="badge bg-secondary" t-esc="wo.work_order_type or 'Other'"/>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <t t-call="records_management.portal_coordinator_state_badge"/>
                                                    </td>
                                                    <td>
                                                        <t t-if="wo.scheduled_date">
                                                            <i class="fa fa-calendar"></i>
                                                            <t t-esc="wo.scheduled_date" t-options="{'widget': 'datetime', 'format': 'short'}"/>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="text-muted">Not scheduled</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <t t-if="wo.priority == '2'">
                                                            <span class="badge bg-danger"><i class="fa fa-exclamation-triangle"></i> Urgent</span>
                                                        </t>
                                                        <t t-elif="wo.priority == '1'">
                                                            <span class="badge bg-warning text-dark"><i class="fa fa-arrow-up"></i> High</span>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="badge bg-secondary">Normal</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <a t-attf-href="/my/coordinators/#{wo.id}" class="btn btn-sm btn-outline-primary">
                                                            <i class="fa fa-eye"></i> View
                                                        </a>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </t>
                            <t t-else="">
                                <div class="alert alert-info text-center m-3">
                                    <i class="fa fa-info-circle fa-2x mb-2"></i><br/>
                                    No work orders found matching your criteria.
                                </div>
                            </t>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <t t-if="pager">
                        <div class="mt-3">
                            <t t-call="portal.pager"/>
                        </div>
                    </t>
                </div>
            </t>
        </template>

        <!-- Kanban Card Sub-template -->
        <template id="portal_coordinator_kanban_card" name="Coordinator Kanban Card">
            <div class="card mb-2 shadow-sm">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong class="d-block" t-esc="wo.display_name or wo.name"/>
                            <small class="text-muted">
                                <t t-if="wo.work_order_type == 'retrieval'">
                                    <i class="fa fa-download text-success"></i> Retrieval
                                </t>
                                <t t-elif="wo.work_order_type == 'shredding'">
                                    <i class="fa fa-cut text-danger"></i> Shredding
                                </t>
                                <t t-elif="wo.work_order_type == 'pickup'">
                                    <i class="fa fa-truck text-primary"></i> Pickup
                                </t>
                                <t t-else="">
                                    <i class="fa fa-tasks"></i> <t t-esc="wo.work_order_type"/>
                                </t>
                            </small>
                        </div>
                        <div>
                            <t t-if="wo.priority == '2'">
                                <span class="badge bg-danger" title="Urgent"><i class="fa fa-exclamation"></i></span>
                            </t>
                            <t t-elif="wo.priority == '1'">
                                <span class="badge bg-warning" title="High Priority"><i class="fa fa-arrow-up"></i></span>
                            </t>
                        </div>
                    </div>
                    <t t-if="wo.scheduled_date">
                        <small class="d-block mt-1">
                            <i class="fa fa-calendar"></i>
                            <t t-esc="wo.scheduled_date" t-options="{'widget': 'datetime', 'format': 'short'}"/>
                        </small>
                    </t>
                    <div class="mt-2">
                        <a t-attf-href="/my/coordinators/#{wo.id}" class="btn btn-sm btn-outline-primary btn-block">
                            <i class="fa fa-eye"></i> View
                        </a>
                    </div>
                </div>
            </div>
        </template>

        <!-- State Badge Sub-template -->
        <template id="portal_coordinator_state_badge" name="Coordinator State Badge">
            <t t-if="wo.state == 'draft'">
                <span class="badge bg-secondary"><i class="fa fa-edit"></i> Draft</span>
            </t>
            <t t-elif="wo.state == 'confirmed'">
                <span class="badge bg-info"><i class="fa fa-check"></i> Confirmed</span>
            </t>
            <t t-elif="wo.state == 'authorized'">
                <span class="badge bg-info"><i class="fa fa-thumbs-up"></i> Authorized</span>
            </t>
            <t t-elif="wo.state == 'assigned'">
                <span class="badge bg-warning text-dark"><i class="fa fa-user"></i> Assigned</span>
            </t>
            <t t-elif="wo.state == 'scheduled'">
                <span class="badge bg-primary"><i class="fa fa-calendar"></i> Scheduled</span>
            </t>
            <t t-elif="wo.state == 'in_progress'">
                <span class="badge bg-primary"><i class="fa fa-cogs"></i> In Progress</span>
            </t>
            <t t-elif="wo.state == 'completed'">
                <span class="badge bg-success"><i class="fa fa-check-circle"></i> Completed</span>
            </t>
            <t t-elif="wo.state == 'verified'">
                <span class="badge bg-success"><i class="fa fa-certificate"></i> Verified</span>
            </t>
            <t t-elif="wo.state == 'certified'">
                <span class="badge bg-success"><i class="fa fa-award"></i> Certified</span>
            </t>
            <t t-elif="wo.state == 'invoiced'">
                <span class="badge bg-dark"><i class="fa fa-file-invoice"></i> Invoiced</span>
            </t>
            <t t-elif="wo.state == 'cancelled'">
                <span class="badge bg-danger"><i class="fa fa-times"></i> Cancelled</span>
            </t>
            <t t-else="">
                <span class="badge bg-secondary" t-esc="wo.state"/>
            </t>
        </template>
        
        <!-- Coordinator View Toggle Script -->
        <template id="portal_coordinator_view_toggle_script" name="Coordinator View Toggle Script" inherit_id="records_management.portal_my_coordinators">
            <xpath expr="//div[hasclass('container-fluid')]" position="after">
                <script type="text/javascript">
                    function toggleCoordinatorView(viewMode) {
                        var kanbanView = document.querySelector('.portal-kanban-view');
                        var listView = document.querySelector('.portal-list-view');
                        var toggleButtons = document.querySelectorAll('.view-toggle-btn');
                        
                        if (!kanbanView || !listView) return;
                        
                        if (viewMode === 'kanban') {
                            kanbanView.classList.remove('d-none');
                            listView.classList.add('d-none');
                        } else {
                            kanbanView.classList.add('d-none');
                            listView.classList.remove('d-none');
                        }
                        
                        toggleButtons.forEach(function(btn) {
                            btn.classList.remove('active');
                            if ((viewMode === 'kanban' &amp;&amp; btn.textContent.includes('Kanban')) ||
                                (viewMode === 'list' &amp;&amp; btn.textContent.includes('List'))) {
                                btn.classList.add('active');
                            }
                        });
                        
                        try {
                            localStorage.setItem('coordinator_view_mode', viewMode);
                        } catch (e) {}
                    }
                    
                    // Initialize from stored preference (default: list)
                    document.addEventListener('DOMContentLoaded', function() {
                        var stored = 'list';
                        try {
                            stored = localStorage.getItem('coordinator_view_mode') || 'list';
                        } catch (e) {}
                        toggleCoordinatorView(stored);
                    });
                </script>
            </xpath>
        </template>
    </data>
</odoo>
