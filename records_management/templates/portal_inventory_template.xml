<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Portal Inventory Dashboard Template -->
        <template id="portal_inventory_dashboard" name="Portal Inventory Dashboard">
            <t t-call="portal.portal_layout">
                <t t-set="breadcrumbs_searchbar" t-value="True"/>

                <t t-call="portal.portal_searchbar">
                    <t t-set="title">Records Inventory</t>
                </t>

                <div class="container-fluid mt-3">
                    <!-- Inventory Overview Cards -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6">
                            <div class="card text-white bg-primary">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="card-title" t-esc="total_boxes"/>
                                            <p class="card-text">Total Boxes</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fa fa-archive fa-2x"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card text-white bg-success">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="card-title" t-esc="total_documents"/>
                                            <p class="card-text">Total Documents</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fa fa-file-o fa-2x"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card text-white bg-warning">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="card-title" t-esc="active_locations"/>
                                            <p class="card-text">Storage Locations</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fa fa-map-marker fa-2x"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card text-white bg-info">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="card-title" t-esc="pending_requests"/>
                                            <p class="card-text">Pending Requests</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fa fa-clock-o fa-2x"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Recent Activity -->
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fa fa-history"/> Recent Activity</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Activity</th>
                                                    <th>Box/Document</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="recent_activities" t-as="activity">
                                                    <tr>
                                                        <td><t t-esc="activity.date"/></td>
                                                        <td><t t-esc="activity.activity_type"/></td>
                                                        <td><t t-esc="activity.reference"/></td>
                                                        <td>
                                                            <span t-att-class="'badge badge-' + activity.status_class">
                                                                <t t-esc="activity.status"/>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fa fa-bolt"/> Quick Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div class="list-group list-group-flush">
                                        <a href="/my/records/boxes" class="list-group-item list-group-item-action">
                                            <i class="fa fa-archive"/> View All Boxes
                                        </a>
                                        <a href="/my/records/documents" class="list-group-item list-group-item-action">
                                            <i class="fa fa-file-o"/> Browse Documents
                                        </a>
                                        <a href="/my/records/requests" class="list-group-item list-group-item-action">
                                            <i class="fa fa-plus"/> New Request
                                        </a>
                                        <a href="/my/records/reports" class="list-group-item list-group-item-action">
                                            <i class="fa fa-bar-chart"/> View Reports
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Storage Summary -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6><i class="fa fa-pie-chart"/> Storage by Location</h6>
                                </div>
                                <div class="card-body">
                                    <t t-if="containers_by_location">
                                        <t t-foreach="containers_by_location.items()" t-as="location_item">
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <small><t t-esc="location_item[0]"/></small>
                                                    <small><t t-esc="location_item[1]"/> containers</small>
                                                </div>
                                            </div>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted mb-0">No containers in storage</p>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search and Filter Section -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fa fa-search"/> Search Inventory</h5>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="/my/inventory/export/excel" class="btn btn-success btn-sm" title="Export to Excel">
                                            <i class="fa fa-file-excel-o"/> Excel
                                        </a>
                                        <a href="/my/inventory/export/pdf" class="btn btn-danger btn-sm" title="Export to PDF">
                                            <i class="fa fa-file-pdf-o"/> PDF
                                        </a>
                                        <button type="button" class="btn btn-info btn-sm" onclick="window.print()" title="Print">
                                            <i class="fa fa-print"/> Print
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Mobile-friendly search form -->
                                    <div class="row">
                                        <div class="col-12 mb-3">
                                            <div class="input-group">
                                                <input type="text" name="search" class="form-control" placeholder="Search boxes or documents..." value="{search or ''}"/>
                                                <div class="input-group-append">
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fa fa-search"/>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 mb-3">
                                            <select name="department" class="form-control">
                                                <option value="">All Departments</option>
                                                <t t-foreach="departments" t-as="dept">
                                                    <option t-att-value="dept.id" t-att-selected="'selected' if dept.id == search_department else None">
                                                        <t t-esc="dept.name"/>
                                                    </option>
                                                </t>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <div class="row">
                                                <div class="col-6">
                                                    <input type="date" name="date_from" class="form-control" placeholder="From Date"/>
                                                </div>
                                                <div class="col-6">
                                                    <input type="date" name="date_to" class="form-control" placeholder="To Date"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Mobile Export Options -->
                                    <div class="row mt-3 d-md-none">
                                        <div class="col-12">
                                            <div class="alert alert-info">
                                                <strong><i class="fa fa-mobile"/> Mobile Export Options</strong>
                                                <div class="mt-2">
                                                    <a href="/my/inventory/export/excel?mobile=1" class="btn btn-success btn-sm mr-2">
                                                        <i class="fa fa-file-excel-o"/> Excel
                                                    </a>
                                                    <a href="/my/inventory/export/pdf?mobile=1" class="btn btn-danger btn-sm mr-2">
                                                        <i class="fa fa-file-pdf-o"/> PDF
                                                    </a>
                                                    <button type="button" class="btn btn-info btn-sm" onclick="window.print()">
                                                        <i class="fa fa-print"/> Print
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </template>

        <!-- Portal Box Details Template -->
        <template id="portal_box_details" name="Portal Box Details">
            <t t-call="portal.portal_layout">
                <div class="container mt-3">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h4>Box Details: <t t-esc="box.name"/></h4>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Location:</strong> <t t-esc="box.location_id.name or 'Not Set'"/></p>
                                            <p><strong>Department:</strong> <t t-esc="box.department_id.name or 'Not Set'"/></p>
                                            <p><strong>Document Count:</strong> <t t-esc="box.document_count"/></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Status:</strong> <t t-esc="dict(box._fields['state'].selection).get(box.state, box.state) if box.state else 'Pending'"/></p>
                                            <p><strong>Last Activity:</strong> <t t-esc="box.last_activity_date"/></p>
                                            <p><strong>Storage Fee:</strong> <t t-esc="box.storage_fee_monthly"/></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Box Actions</h6>
                                </div>
                                <div class="card-body">
                                    <a href="#" class="btn btn-primary btn-block mb-2">
                                        <i class="fa fa-hand-paper-o"/> Request Retrieval
                                    </a>
                                    <a href="#" class="btn btn-secondary btn-block mb-2">
                                        <i class="fa fa-file-o"/> View Documents
                                    </a>
                                    <div class="btn-group-vertical btn-block" role="group">
                                        <a href="/my/box/{box.id}/export/pdf" class="btn btn-danger btn-sm">
                                            <i class="fa fa-file-pdf-o"/> PDF Report
                                        </a>
                                        <a href="/my/box/{box.id}/export/excel" class="btn btn-success btn-sm">
                                            <i class="fa fa-file-excel-o"/> Excel Details
                                        </a>
                                        <button type="button" class="btn btn-info btn-sm" onclick="window.print()">
                                            <i class="fa fa-print"/> Print Details
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Mobile Quick Actions -->
                            <div class="card mt-3 d-md-none">
                                <div class="card-header">
                                    <h6><i class="fa fa-mobile"/> Quick Actions</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <a t-att-href="'tel:' + (request.env.company.phone or '+1-555-0123')" class="btn btn-outline-primary btn-sm btn-block">
                                                <i class="fa fa-phone"/> Call
                                            </a>
                                        </div>
                                        <div class="col-6">
                                            <a t-att-href="'mailto:' + (request.env['ir.config_parameter'].sudo().get_param('records_management.support_email') or request.env.company.email or 'support@records.com')" class="btn btn-outline-secondary btn-sm btn-block">
                                                <i class="fa fa-envelope"/> Email
                                            </a>
                                        </div>
                                        <div class="col-6">
                                            <button type="button" class="btn btn-outline-info btn-sm btn-block" onclick="navigator.share({title: 'Box {box.name}', text: 'Box details from Records Management', url: window.location.href})">
                                                <i class="fa fa-share"/> Share
                                            </button>
                                        </div>
                                        <div class="col-6">
                                            <button type="button" class="btn btn-outline-warning btn-sm btn-block" onclick="window.print()">
                                                <i class="fa fa-print"/> Print
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </template>

        <!-- Inventory Template (for /my/inventory route) -->
        <template id="inventory_template" name="My Inventory">
            <t t-call="portal.portal_layout">
                <t t-set="breadcrumbs_searchbar" t-value="True"/>
                <t t-set="title">My Inventory</t>

                <div class="o_portal_inventory">
                    <!-- Messages -->
                    <t t-if="message">
                        <div t-attf-class="alert alert-#{message_type} alert-dismissible fade show" role="alert">
                            <i t-if="message_type == 'success'" class="fa fa-check-circle"></i>
                            <i t-if="message_type == 'danger'" class="fa fa-exclamation-triangle"></i>
                            <i t-if="message_type == 'info'" class="fa fa-info-circle"></i>
                            <span t-esc="message"/>
                            <button type="button" class="close" data-dismiss="alert">
                                <span>&amp;times;</span>
                            </button>
                        </div>
                    </t>

                    <!-- Header Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h3 class="mb-0">
                                <i class="fa fa-boxes"></i>
                                Inventory Management
                            </h3>
                        </div>
                        <div class="card-body">
                            <!-- Stats -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="card border-info">
                                        <div class="card-body text-center">
                                            <h5 class="text-info"><i class="fa fa-boxes"></i></h5>
                                            <h4 class="mb-0" t-esc="total_count"/>
                                            <small class="text-muted">Total Items</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <h5 class="text-success"><i class="fa fa-warehouse"></i></h5>
                                            <h4 class="mb-0" t-esc="len(set(quants.mapped('location_id')))"/>
                                            <small class="text-muted">Locations</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <h5 class="text-warning"><i class="fa fa-file-alt"></i></h5>
                                            <h4 class="mb-0" t-esc="len(set(quants.mapped('product_id')))"/>
                                            <small class="text-muted">Product Types</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Search Bar -->
                            <form method="GET" action="/my/inventory" class="mb-3">
                                <div class="input-group">
                                    <input type="text" name="search" class="form-control" 
                                           placeholder="Search by product name, code, or location..."
                                           t-att-value="search_term"/>
                                    <div class="input-group-append">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fa fa-search"></i> Search
                                        </button>
                                        <t t-if="search_term">
                                            <a href="/my/inventory" class="btn btn-outline-secondary">
                                                <i class="fa fa-times"></i> Clear
                                            </a>
                                        </t>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Inventory Table -->
                    <div class="card">
                        <div class="card-body">
                            <t t-if="not quants">
                                <div class="alert alert-info text-center py-5">
                                    <i class="fa fa-inbox fa-3x mb-3 text-muted"></i>
                                    <h4>No Inventory Found</h4>
                                    <p class="mb-0">
                                        <t t-if="search_term">
                                            No items match your search "<span t-esc="search_term"/>".
                                            <a href="/my/inventory">View all inventory</a>
                                        </t>
                                        <t t-else="">
                                            You don't have any inventory items yet.
                                        </t>
                                    </p>
                                </div>
                            </t>

                            <t t-if="quants">
                                <!-- Request Pickup Form -->
                                <form id="pickup_form" action="/my/inventory/request_pickup" method="POST" class="mb-3">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <button type="submit" class="btn btn-danger" id="request_pickup_btn" disabled="disabled">
                                        <i class="fa fa-truck"></i> Request Pickup for Selected Items
                                    </button>
                                    <small class="form-text text-muted ml-2" t-esc="tooltips.get('pickup', '')"/>
                                </form>

                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="thead-light">
                                            <tr>
                                                <th width="50">
                                                    <input type="checkbox" id="select_all"/>
                                                </th>
                                                <th>Product</th>
                                                <th>Product Code</th>
                                                <th>Location</th>
                                                <th>Quantity</th>
                                                <th>Last Updated</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="quants" t-as="quant">
                                                <tr>
                                                    <td>
                                                        <input type="checkbox" name="quant_ids" 
                                                               t-att-value="quant.id" 
                                                               class="quant_checkbox"
                                                               form="pickup_form"/>
                                                    </td>
                                                    <td>
                                                        <strong t-esc="quant.product_id.name"/>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-secondary" t-esc="quant.product_id.default_code or 'N/A'"/>
                                                    </td>
                                                    <td>
                                                        <i class="fa fa-map-marker-alt text-info"></i>
                                                        <span t-esc="quant.location_id.complete_name"/>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-primary" t-esc="'%.2f %s' % (quant.quantity, quant.product_uom_id.name)"/>
                                                    </td>
                                                    <td t-esc="quant.write_date.strftime('%Y-%m-%d %H:%M') if quant.write_date else 'N/A'"/>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                <t t-if="total_pages &gt; 1">
                                    <nav aria-label="Inventory pagination">
                                        <ul class="pagination justify-content-center mt-4">
                                            <li t-att-class="'page-item' + (' disabled' if not has_prev else '')">
                                                <a t-if="has_prev" class="page-link" 
                                                   t-attf-href="/my/inventory?page=#{prev_page}#{('&amp;search=' + search_term) if search_term else ''}">
                                                    <i class="fa fa-chevron-left"></i> Previous
                                                </a>
                                                <span t-if="not has_prev" class="page-link">
                                                    <i class="fa fa-chevron-left"></i> Previous
                                                </span>
                                            </li>
                                            
                                            <li class="page-item active">
                                                <span class="page-link">
                                                    Page <t t-esc="current_page"/> of <t t-esc="total_pages"/>
                                                </span>
                                            </li>
                                            
                                            <li t-att-class="'page-item' + (' disabled' if not has_next else '')">
                                                <a t-if="has_next" class="page-link"
                                                   t-attf-href="/my/inventory?page=#{next_page}#{('&amp;search=' + search_term) if search_term else ''}">
                                                    Next <i class="fa fa-chevron-right"></i>
                                                </a>
                                                <span t-if="not has_next" class="page-link">
                                                    Next <i class="fa fa-chevron-right"></i>
                                                </span>
                                            </li>
                                        </ul>
                                    </nav>
                                </t>
                            </t>
                        </div>
                    </div>
                </div>

                <!-- JavaScript for checkbox handling -->
                <script type="text/javascript">
                    $(document).ready(function() {
                        // Enable/disable Request Pickup button based on checkbox selection
                        function updatePickupButton() {
                            var anyChecked = $('.quant_checkbox:checked').length > 0;
                            $('#request_pickup_btn').prop('disabled', !anyChecked);
                        }

                        // Select all functionality
                        $('#select_all').on('change', function() {
                            $('.quant_checkbox').prop('checked', this.checked);
                            updatePickupButton();
                        });

                        // Individual checkbox handling
                        $('.quant_checkbox').on('change', function() {
                            var allChecked = $('.quant_checkbox').length === $('.quant_checkbox:checked').length;
                            $('#select_all').prop('checked', allChecked);
                            updatePickupButton();
                        });

                        // Initialize tooltips
                        $('[data-toggle="tooltip"]').tooltip();
                    });
                </script>
            </t>
        </template>

    </data>
    </odoo>
