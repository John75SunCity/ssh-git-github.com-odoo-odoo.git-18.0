<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <record id="chain_of_custody_view_list" model="ir.ui.view">
            <field name="name">chain.of.custody.view.list</field>
            <field name="model">chain.of.custody</field>
            <field name="arch" type="xml">
                <list decoration-success="state == 'completed'" decoration-warning="state == 'in_progress'" decoration-danger="state == 'cancelled'">
                    <field name="name" />
                    <field name="partner_id" />
                    <field name="transfer_date" />
                    <field name="document_ids" widget="many2many_tags" optional="hide" />
                    <field name="container_ids" widget="many2many_tags" optional="hide" />
                    <field name="from_custodian_id" optional="hide" />
                    <field name="to_custodian_id" />
                    <field name="state" widget="badge" />
                    <button name="action_start" type="object" string="Start" class="btn-link" icon="fa-play" invisible="state != 'draft'" />
                    <button name="action_complete" type="object" string="Complete" class="btn-link" icon="fa-check" invisible="state != 'in_progress'" />
                    <button name="action_cancel" type="object" string="Cancel" class="btn-link" icon="fa-times" invisible="state in ['completed','cancelled']" />
                </list>
            </field>
        </record>
        <record id="chain_of_custody_view_form" model="ir.ui.view">
            <field name="name">chain.of.custody.view.form</field>
            <field name="model">chain.of.custody</field>
            <field name="arch" type="xml">
                <form>
                    <header>
                        <button name="action_start" type="object" string="Start" class="btn-primary" invisible="state != 'draft'" />
                        <button name="action_complete" type="object" string="Complete" class="btn-success" invisible="state != 'in_progress'" />
                        <button name="action_cancel" type="object" string="Cancel" class="btn-danger" invisible="state in ['completed','cancelled']" />
                        <button name="action_reset_to_draft" type="object" string="Reset to Draft" class="btn-secondary" invisible="state == 'draft'" />
                        <field name="state" widget="statusbar" statusbar_visible="draft,in_progress,completed,cancelled" />
                    </header>
                    <sheet>
                        <group>
                            <group string="Transfer Information">
                                <field name="name" />
                                <field name="transfer_date" />
                                <field name="transfer_date" />
                                <field name="department_id" />
                                <field name="partner_id" readonly="1" />
                            </group>
                            <group string="Custodians">
                                <field name="from_custodian_id" />
                                <field name="to_custodian_id" />
                                <field name="witness_id" />
                            </group>
                        </group>
                        <group>
                            <group string="Locations">
                                <field name="from_location_id" />
                                <field name="to_location_id" />
                            </group>
                            <group string="Items">
                                <field name="document_ids" widget="many2many_tags" options="{'no_create': True}" />
                                <field name="container_ids" widget="many2many_tags" options="{'no_create': True}" />
                            </group>
                        </group>
                        <notebook>
                            <page string="Events">
                                <field name="custody_event_ids" mode="list,form" />
                            </page>
                            <page string="Notes">
                                <field name="notes" widget="text" />
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" />
                        <field name="activity_ids" />
                        <field name="message_ids" />
                    </div>
                </form>
            </field>
        </record>
        <record id="chain_of_custody_view_kanban" model="ir.ui.view">
            <field name="name">chain.of.custody.view.kanban</field>
            <field name="model">chain.of.custody</field>
            <field name="arch" type="xml">
                <kanban default_group_by="state">
                    <field name="name" />
                    <field name="partner_id" />
                    <field name="transfer_date" />
                    <field name="from_custodian_id" />
                    <field name="to_custodian_id" />
                    <field name="state" />
                    <field name="document_ids" />
                    <field name="container_ids" />
                    <templates>
                        <t t-name="card">
                            <div class="oe_kanban_card oe_kanban_global_click">
                                <strong>
                                    <field name="name" />
                                </strong>
                                <div>
                                    <field name="partner_id" /> - <field name="transfer_date" />
                                </div>
                                <div>
                                    <field name="from_custodian_id" /> ‚Üí <field name="to_custodian_id" />
                                </div>
                                <div>
                                    <field name="transfer_date" />
                                </div>
                                <div t-if="record.document_ids.raw_value and record.document_ids.raw_value.length">Docs: <field name="document_ids" />
                                </div>
                                <div t-if="record.container_ids.raw_value and record.container_ids.raw_value.length">Containers: <field name="container_ids" />
                                </div>
                                <div class="mt-1">
                                    <span class="badge" t-esc="record.state.raw_value" />
                                </div>
                                <div class="mt-2">
                                    <button type="object" name="action_start" class="btn btn-primary btn-sm" t-if="record.state.raw_value == 'draft'">Start</button>
                                    <button type="object" name="action_complete" class="btn btn-success btn-sm" t-if="record.state.raw_value == 'in_progress'">Complete</button>
                                    <button type="object" name="action_cancel" class="btn btn-danger btn-sm" t-if="record.state.raw_value not in ['completed','cancelled']">Cancel</button>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>
        <record id="chain_of_custody_view_search" model="ir.ui.view">
            <field name="name">chain.of.custody.view.search</field>
            <field name="model">chain.of.custody</field>
            <field name="arch" type="xml">
                <search>
                    <field name="name" />
                    <field name="partner_id" />
                    <field name="from_custodian_id" />
                    <field name="to_custodian_id" />
                    <field name="transfer_date" />
                    <field name="document_ids" />
                    <field name="container_ids" />
                    <filter string="Draft" name="draft" domain="[('state', '=', 'draft')]" />
                    <filter string="In Progress" name="in_progress" domain="[('state', '=', 'in_progress')]" />
                    <filter string="Completed" name="completed" domain="[('state', '=', 'completed')]" />
                    <filter string="Cancelled" name="cancelled" domain="[('state', '=', 'cancelled')]" />
                    <separator />
                    <filter string="My Transfers" name="my_transfers" domain="[('create_uid', '=', uid)]" />
                    <group expand="0" string="Group By">
                        <filter string="Status" name="group_by_state" context="{'group_by': 'state'}" />
                        <filter string="Customer" name="group_by_customer" context="{'group_by': 'partner_id'}" />
                        <filter string="Transfer Type" name="group_by_type" context="{'group_by': 'transfer_type'}" />
                        <filter string="From Custodian" name="group_by_from" context="{'group_by': 'from_custodian_id'}" />
                        <filter string="To Custodian" name="group_by_to" context="{'group_by': 'to_custodian_id'}" />
                        <filter string="Transfer Month" name="group_by_month" context="{'group_by': 'transfer_date:month'}" />
                    </group>
                </search>
            </field>
        </record>
        <!-- NOTE: action_chain_of_custody and action_chain_of_custody_customer moved to chain_of_custody_actions.xml (loads earlier, before root menus) -->
        <!-- Here we enhance those actions with search view references and context now that views are defined -->
        <record id="action_chain_of_custody" model="ir.actions.act_window">
            <field name="search_view_id" ref="chain_of_custody_view_search" />
            <field name="context">{'search_default_draft': 1, 'search_default_in_progress': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    <i class="fa fa-exchange"/> No chain of custody transfers yet!
                </p>
                <p>
                    <b>‚ö†Ô∏è Prerequisites for custody transfers:</b>
                </p>
                <ul>
                    <li>‚úì <b>Custodians Defined</b> - Go to: <i>Settings &gt; Users</i> (assign users as authorized custodians)</li>
                    <li>‚úì <b>Locations Setup</b> - Go to: <i>Configuration &gt; Master Data &gt; Storage Locations</i></li>
                    <li>‚úì <b>Documents/Containers</b> - Must have items ready to transfer in the system</li>
                    <li>‚úì <b>Witness Available</b> - Optional but recommended for high-security transfers</li>
                </ul>
                <p>
                    <b>üìã Understanding Chain of Custody:</b>
                </p>
                <p>
                    Chain of Custody provides a complete, <b>NAID AAA compliant audit trail</b> for every 
                    document and container transfer. This ensures accountability, security, and regulatory 
                    compliance by tracking who, what, when, where, and why for every custody change.
                </p>
                <p>
                    <b>üéØ To create a custody transfer:</b>
                </p>
                <ol>
                    <li>Click the <b>New</b> button above</li>
                    <li>System auto-generates <b>Transfer Name</b> (e.g., "COC-2025-001")</li>
                    <li>Set <b>Transfer Date</b> (when physical custody changes)</li>
                    <li>Select <b>Customer</b> and <b>Department</b> (if applicable)</li>
                    <li>Assign custodians:
                        <ul>
                            <li><b>From Custodian:</b> Current person responsible</li>
                            <li><b>To Custodian:</b> New person taking responsibility</li>
                            <li><b>Witness:</b> Optional third party to verify transfer</li>
                        </ul>
                    </li>
                    <li>Specify locations:
                        <ul>
                            <li><b>From Location:</b> Current storage location</li>
                            <li><b>To Location:</b> Destination location</li>
                        </ul>
                    </li>
                    <li>Add items being transferred:
                        <ul>
                            <li><b>Documents:</b> Individual document records</li>
                            <li><b>Containers:</b> Entire containers (includes all contents)</li>
                        </ul>
                    </li>
                    <li>Add transfer <b>Notes</b> (reason, special instructions, conditions)</li>
                    <li>Click <b>Start</b> to initiate the transfer (locks the record)</li>
                    <li>When physical transfer is complete, click <b>Complete</b></li>
                </ol>
                <p>
                    <b>üìä Custody Transfer States:</b>
                </p>
                <ul>
                    <li><b>Draft:</b> Transfer being planned, can be edited</li>
                    <li><b>In Progress:</b> Transfer started, physical movement underway</li>
                    <li><b>Completed:</b> Transfer confirmed, custody officially changed</li>
                    <li><b>Cancelled:</b> Transfer aborted (items remain with original custodian)</li>
                </ul>
                <p>
                    <b>üöÄ NAID AAA Compliance Features:</b><br/>
                    ‚Ä¢ Complete audit trail for every custody change<br/>
                    ‚Ä¢ Timestamped custody events with user tracking<br/>
                    ‚Ä¢ Multi-party verification (from, to, witness)<br/>
                    ‚Ä¢ Location tracking (origin and destination)<br/>
                    ‚Ä¢ Immutable event log for regulatory compliance<br/>
                    ‚Ä¢ Digital signatures for high-security transfers<br/>
                    ‚Ä¢ Integration with NAID audit logs<br/>
                    ‚Ä¢ Real-time status tracking and notifications
                </p>
                <p>
                    <b>üí° Best Practice:</b> Always specify both custodians and add detailed notes explaining the reason for transfer. Use <b>Witness</b> for high-value or sensitive transfers.
                </p>
            </field>
        </record>
        <record id="action_chain_of_custody_customer" model="ir.actions.act_window">
            <field name="search_view_id" ref="chain_of_custody_view_search" />
            <field name="domain">[('partner_id', '=', active_id)]</field>
            <field name="context">{'default_partner_id': active_id, 'search_default_draft': 1, 'search_default_in_progress': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No chain of custody records found for this customer.
                </p>
                <p>
                    Create a new transfer record to track document and container movements.
                </p>
            </field>
        </record>
    </data>
</odoo>
