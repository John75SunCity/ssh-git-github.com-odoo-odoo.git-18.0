<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ============================================================================
             UNIFIED WORK ORDER - TREE VIEW
             ============================================================================ -->
        <record id="unified_work_order_view_list" model="ir.ui.view">
            <field name="name">unified.work.order.view.list</field>
            <field name="model">unified.work.order</field>
            <field name="arch" type="xml">
                <list decoration-danger="priority == '2'" 
                      decoration-warning="state == 'in_progress'"
                      decoration-muted="state == 'cancelled'"
                      decoration-success="state in ('completed', 'invoiced')">
                    <field name="scheduled_date" widget="datetime"/>
                    <field name="name"/>
                    <field name="partner_id"/>
                    <field name="work_order_type" widget="badge" 
                           decoration-info="work_order_type in ('retrieval', 'delivery', 'pickup', 'container_access')"
                           decoration-danger="work_order_type in ('container_destruction', 'shredding')"/>
                    <field name="state" widget="badge"
                           decoration-info="state == 'scheduled'"
                           decoration-warning="state == 'in_progress'"
                           decoration-success="state in ('completed', 'invoiced')"
                           decoration-danger="state == 'cancelled'"/>
                    <field name="priority" widget="priority"/>
                    <field name="user_id" widget="many2one_avatar_user"/>
                    <field name="is_portal_order" widget="boolean"/>
                    <field name="source_model" column_invisible="1"/>
                    <field name="source_id" column_invisible="1"/>
                    <button name="action_open_source_record" type="object" 
                            string="Open" icon="fa-external-link" 
                            class="btn-link"/>
                </list>
            </field>
        </record>

        <!-- ============================================================================
             UNIFIED WORK ORDER - KANBAN VIEW
             ============================================================================ -->
        <record id="unified_work_order_view_kanban" model="ir.ui.view">
            <field name="name">unified.work.order.view.kanban</field>
            <field name="model">unified.work.order</field>
            <field name="arch" type="xml">
                <kanban default_group_by="state" class="o_kanban_small_column"
                        quick_create="false" records_draggable="false">
                    <field name="id"/>
                    <field name="name"/>
                    <field name="display_name"/>
                    <field name="partner_id"/>
                    <field name="work_order_type"/>
                    <field name="service_category"/>
                    <field name="state"/>
                    <field name="priority"/>
                    <field name="scheduled_date"/>
                    <field name="user_id"/>
                    <field name="is_portal_order"/>
                    <field name="color"/>
                    <field name="source_model"/>
                    <field name="source_id"/>
                    <templates>
                        <t t-name="card">
                            <div t-attf-class="oe_kanban_color_#{kanban_getcolor(record.color.raw_value)} oe_kanban_card oe_kanban_global_click">
                                <div class="oe_kanban_content">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <field name="display_name"/>
                                            </strong>
                                        </div>
                                        <field name="priority" widget="priority"/>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <div class="mb-1">
                                            <i class="fa fa-user me-1" title="Customer"/>
                                            <field name="partner_id"/>
                                        </div>
                                        <div class="mb-1">
                                            <span t-attf-class="badge #{record.service_category.raw_value == 'storage' ? 'bg-info' : 'bg-danger'}">
                                                <field name="work_order_type"/>
                                            </span>
                                        </div>
                                        <div class="text-muted small">
                                            <i class="fa fa-calendar me-1" title="Scheduled Date"/>
                                            <field name="scheduled_date" widget="datetime"/>
                                        </div>
                                    </div>
                                    <div class="o_kanban_record_bottom">
                                        <div class="oe_kanban_bottom_left">
                                            <t t-if="record.is_portal_order.raw_value">
                                                <span class="badge bg-secondary" title="From Portal">
                                                    <i class="fa fa-globe"/> Portal
                                                </span>
                                            </t>
                                        </div>
                                        <div class="oe_kanban_bottom_right">
                                            <field name="user_id" widget="many2one_avatar_user"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- ============================================================================
             UNIFIED WORK ORDER - CALENDAR VIEW
             ============================================================================ -->
        <record id="unified_work_order_view_calendar" model="ir.ui.view">
            <field name="name">unified.work.order.view.calendar</field>
            <field name="model">unified.work.order</field>
            <field name="arch" type="xml">
                <calendar string="Work Orders" date_start="scheduled_date" 
                          color="work_order_type" mode="week" quick_create="0">
                    <field name="display_name"/>
                    <field name="partner_id"/>
                    <field name="work_order_type"/>
                    <field name="state"/>
                </calendar>
            </field>
        </record>

        <!-- ============================================================================
             UNIFIED WORK ORDER - SEARCH VIEW
             ============================================================================ -->
        <record id="unified_work_order_view_search" model="ir.ui.view">
            <field name="name">unified.work.order.view.search</field>
            <field name="model">unified.work.order</field>
            <field name="arch" type="xml">
                <search string="Search Work Orders">
                    <field name="name"/>
                    <field name="display_name"/>
                    <field name="partner_id"/>
                    <field name="user_id"/>
                    <separator/>
                    <!-- Status Filters - Simplified workflow -->
                    <filter name="filter_scheduled" string="Scheduled" domain="[('state', '=', 'scheduled')]"/>
                    <filter name="filter_in_progress" string="In Progress" domain="[('state', '=', 'in_progress')]"/>
                    <filter name="filter_completed" string="Completed" domain="[('state', 'in', ['completed', 'invoiced'])]"/>
                    <filter name="filter_cancelled" string="Cancelled" domain="[('state', '=', 'cancelled')]"/>
                    <separator/>
                    <!-- Open Orders (not completed/cancelled) -->
                    <filter name="filter_open" string="Open Orders" 
                            domain="[('state', 'not in', ['completed', 'invoiced', 'cancelled'])]"/>
                    <separator/>
                    <!-- Category Filters -->
                    <filter name="filter_storage" string="Storage Services" domain="[('service_category', '=', 'storage')]"/>
                    <filter name="filter_destruction" string="Destruction Services" domain="[('service_category', '=', 'destruction')]"/>
                    <separator/>
                    <!-- Type Filters -->
                    <filter name="filter_retrieval" string="Retrieval" domain="[('work_order_type', '=', 'retrieval')]"/>
                    <filter name="filter_delivery" string="Delivery" domain="[('work_order_type', '=', 'delivery')]"/>
                    <filter name="filter_pickup" string="Pickup" domain="[('work_order_type', '=', 'pickup')]"/>
                    <filter name="filter_container_destruction" string="Container Destruction" domain="[('work_order_type', '=', 'container_destruction')]"/>
                    <filter name="filter_shredding" string="Shredding" domain="[('work_order_type', '=', 'shredding')]"/>
                    <separator/>
                    <!-- Priority -->
                    <filter name="filter_urgent" string="Urgent" domain="[('priority', '=', '2')]"/>
                    <filter name="filter_high" string="High Priority" domain="[('priority', '=', '1')]"/>
                    <separator/>
                    <!-- Source -->
                    <filter name="filter_portal" string="From Portal" domain="[('is_portal_order', '=', True)]"/>
                    <filter name="filter_internal" string="Internal" domain="[('is_portal_order', '=', False)]"/>
                    <separator/>
                    <!-- Date Filters -->
                    <filter name="filter_today" string="Today" domain="[('scheduled_date', '&gt;=', (context_today()).strftime('%Y-%m-%d')), ('scheduled_date', '&lt;', (context_today() + relativedelta(days=1)).strftime('%Y-%m-%d'))]"/>
                    <filter name="filter_this_week" string="This Week" domain="[('scheduled_date', '&gt;=', (context_today() - relativedelta(weekday=0)).strftime('%Y-%m-%d')), ('scheduled_date', '&lt;', (context_today() + relativedelta(weeks=1, weekday=0)).strftime('%Y-%m-%d'))]"/>
                    <separator/>
                    <!-- Group By -->
                    <group expand="1" string="Group By">
                        <filter string="Status" name="groupby_state" context="{'group_by': 'state'}"/>
                        <filter string="Type" name="groupby_type" context="{'group_by': 'work_order_type'}"/>
                        <filter string="Category" name="groupby_category" context="{'group_by': 'service_category'}"/>
                        <filter string="Customer" name="groupby_customer" context="{'group_by': 'partner_id'}"/>
                        <filter string="Assigned To" name="groupby_user" context="{'group_by': 'user_id'}"/>
                        <filter string="Scheduled Date" name="groupby_date" context="{'group_by': 'scheduled_date:day'}"/>
                        <filter string="Priority" name="groupby_priority" context="{'group_by': 'priority'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- ============================================================================
             UNIFIED WORK ORDER - FORM VIEW (Read-only, opens actual record)
             ============================================================================ -->
        <record id="unified_work_order_view_form" model="ir.ui.view">
            <field name="name">unified.work.order.view.form</field>
            <field name="model">unified.work.order</field>
            <field name="arch" type="xml">
                <form string="Work Order" create="false" edit="false">
                    <header>
                        <button name="action_open_source_record" string="Open Full Record" type="object" class="btn-primary"/>
                        <button name="action_view_portal_request" string="View Portal Request" type="object" 
                                class="btn-secondary" invisible="not is_portal_order"/>
                        <field name="state" widget="statusbar"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box"/>
                        <widget name="web_ribbon" title="Urgent" bg_color="text-bg-danger" invisible="priority != '2'"/>
                        <widget name="web_ribbon" title="From Portal" bg_color="text-bg-info" invisible="not is_portal_order"/>
                        <div class="oe_title">
                            <h1>
                                <field name="display_name" readonly="1"/>
                            </h1>
                        </div>
                        <group>
                            <group string="General">
                                <field name="work_order_type"/>
                                <field name="service_category"/>
                                <field name="partner_id"/>
                                <field name="priority" widget="priority"/>
                            </group>
                            <group string="Schedule">
                                <field name="scheduled_date"/>
                                <field name="completion_date"/>
                                <field name="user_id"/>
                            </group>
                        </group>
                        <group string="Source">
                            <field name="source_model"/>
                            <field name="source_id"/>
                            <field name="portal_request_id" invisible="not is_portal_order"
                                   domain="[('partner_id', '=', partner_id), ('state', 'not in', ['completed', 'rejected', 'cancelled'])]"
                                   options="{'no_create': True}"/>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- ============================================================================
             ACTION - DISPATCH CENTER
             ============================================================================ -->
        <record id="action_dispatch_center" model="ir.actions.act_window">
            <field name="name">Dispatch Center</field>
            <field name="res_model">unified.work.order</field>
            <field name="view_mode">kanban,list,calendar</field>
            <field name="search_view_id" ref="unified_work_order_view_search"/>
            <field name="context">{
                'search_default_filter_open': 1,
                'search_default_groupby_state': 1,
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No work orders found
                </p>
                <p>
                    Create a new work order using the "New Work Order" button above.
                </p>
            </field>
        </record>

        <!-- ============================================================================
             UNIFIED WORK ORDER - FORM VIEW (Redirect to Source)
             ============================================================================ -->
        <record id="unified_work_order_view_form" model="ir.ui.view">
            <field name="name">unified.work.order.view.form</field>
            <field name="model">unified.work.order</field>
            <field name="arch" type="xml">
                <form string="Work Order" create="false" edit="false">
                    <header>
                        <button name="action_open_source_record" 
                                string="Open Full Work Order" 
                                type="object" 
                                class="btn-primary"/>
                        <field name="state" widget="statusbar"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <h1><field name="display_name"/></h1>
                        </div>
                        <group>
                            <group>
                                <field name="partner_id"/>
                                <field name="work_order_type" widget="badge"/>
                                <field name="scheduled_date"/>
                            </group>
                            <group>
                                <field name="user_id"/>
                                <field name="priority" widget="priority"/>
                                <field name="is_portal_order"/>
                            </group>
                        </group>
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fa fa-info-circle"/> 
                            Click <b>"Open Full Work Order"</b> above to view and edit all details.
                        </div>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- All Work Orders (includes completed) -->
        <record id="action_all_work_orders" model="ir.actions.act_window">
            <field name="name">All Work Orders</field>
            <field name="res_model">unified.work.order</field>
            <field name="view_mode">list,kanban,calendar,form</field>
            <field name="view_id" ref="unified_work_order_view_list"/>
            <field name="search_view_id" ref="unified_work_order_view_search"/>
            <field name="context">{}</field>
        </record>

        <!-- Today's Dispatch -->
        <record id="action_todays_dispatch" model="ir.actions.act_window">
            <field name="name">Today's Dispatch</field>
            <field name="res_model">unified.work.order</field>
            <field name="view_mode">kanban,list,calendar</field>
            <field name="search_view_id" ref="unified_work_order_view_search"/>
            <field name="context">{
                'search_default_filter_today': 1,
                'search_default_groupby_type': 1,
            }</field>
        </record>

    </data>
</odoo>
